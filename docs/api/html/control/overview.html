<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.7.5" />
<title>control.overview API documentation</title>
<meta name="description" content="Overview page of contributions …" />
<link href='https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.0/normalize.min.css' rel='stylesheet'>
<link href='https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/8.0.0/sanitize.min.css' rel='stylesheet'>
<link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" rel="stylesheet">
<style>.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{font-weight:bold}#index h4 + ul{margin-bottom:.6em}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>control.overview</code></h1>
</header>
<section id="section-intro">
<p>Overview page of contributions.</p>
<ul>
<li>Country selection</li>
<li>Grouping by categories</li>
<li>Statistics</li>
</ul>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">&#34;&#34;&#34;Overview page of contributions.

*   Country selection
*   Grouping by categories
*   Statistics
&#34;&#34;&#34;

import json
from flask import request, make_response

from config import Config as C, Names as N
from control.utils import pick as G, E, NBSP, COMMA, PLUS, MIN, ONE, MINONE, S, NL, TAB
from control.html import HtmlElements as H


CT = C.tables
CW = C.web

URLS = CW.urls
PAGE = URLS[N.info][N.url]
PAGEX = f&#34;&#34;&#34;{PAGE}.tsv&#34;&#34;&#34;

COL_PLURAL = dict(country=N.countries,)

COLSPECS = (
    (N.country, str),
    (N.year, int),
    (N.type, str),
    (N.cost, int, &#34;&#34;&#34;cost (€)&#34;&#34;&#34;),
    (N.assessed, tuple),
    (N.selected, bool),
    (N.title, str),
)

GROUP_COLS = &#34;&#34;&#34;
      country
      year
      type
      assessed
      selected
&#34;&#34;&#34;.strip().split()

SUBHEAD_X_COLS = set(
    &#34;&#34;&#34;
  cost
  title
&#34;&#34;&#34;.strip().split()
)

ASSESSED_STATUS = {
    None: (&#34;no&#34;, &#34;a-none&#34;),
    N.incomplete: (&#34;started&#34;, &#34;a-started&#34;),
    N.incompleteRevised: (&#34;revision&#34;, &#34;a-started&#34;),
    N.incompleteWithdrawn: (&#34;withdrawn&#34;, &#34;a-none&#34;),
    N.complete: (&#34;filled-in&#34;, &#34;a-self&#34;),
    N.completeRevised: (&#34;revised&#34;, &#34;a-self&#34;),
    N.completeWithdrawn: (&#34;withdrawn&#34;, &#34;a-none&#34;),
    N.submitted: (&#34;in review&#34;, &#34;a-inreview&#34;),
    N.submittedRevised: (&#34;in review&#34;, &#34;a-inreview&#34;),
    N.reviewReject: (&#34;rejected&#34;, &#34;a-rejected&#34;),
    N.reviewAccept: (&#34;accepted&#34;, &#34;a-accepted&#34;),
}
ASSESSED_LABELS = {stage: info[0] for (stage, info) in ASSESSED_STATUS.items()}
ASSESSED_CLASS = {stage: info[1] for (stage, info) in ASSESSED_STATUS.items()}
ASSESSED_CLASS1 = {info[0]: info[1] for info in ASSESSED_STATUS.values()}
ASSESSED_ACCEPTED_CLASS = ASSESSED_STATUS[N.reviewAccept][1]
ASSESSED_RANK = {stage: i for (i, stage) in enumerate(ASSESSED_STATUS)}

ALL = &#34;&#34;&#34;All countries&#34;&#34;&#34;


class Overview:
    def __init__(self, context):
        self.context = context

        types = context.types
        self.bool3Obj = types.bool3
        self.countryType = types.country
        self.yearType = types.year
        self.typeType = types.typeContribution

    def getCountry(self, country):
        context = self.context
        db = context.db
        auth = context.auth
        user = auth.user
        countryType = self.countryType

        self.userGroup = auth.groupRep()
        self.myCountry = auth.countryRep()

        userCountryId = G(user, N.country)
        chosenCountry = None
        chosenCountryIso = None
        chosenCountryId = None

        countryId = G(db.countryInv, country) if country else userCountryId

        if countryId is not None:
            chosenCountryId = countryId
            countryInfo = G(db.country, chosenCountryId, default={})
            chosenCountry = countryType.titleStr(countryInfo)
            chosenCountryIso = G(countryInfo, N.iso)

        self.chosenCountry = chosenCountry
        self.chosenCountryId = chosenCountryId
        self.chosenCountryIso = chosenCountryIso

    def getContribs(self):
        context = self.context
        db = context.db
        chosenCountryId = self.chosenCountryId
        countryType = self.countryType
        yearType = self.yearType
        typeType = self.typeType

        contribs = {}
        for record in db.bulkContribWorkflow(chosenCountryId):
            title = G(record, N.title)
            contribId = G(record, N._id)

            selected = G(record, N.selected)
            aStage = G(record, N.aStage)
            rStage = G(record, N.rStage)
            if rStage in {N.reviewAccept, N.reviewReject}:
                aStage = rStage
            score = G(record, N.score)
            assessed = ASSESSED_STATUS[aStage][0]
            aRank = (G(ASSESSED_RANK, aStage, default=0), score)
            if aStage != N.reviewAccept:
                score = None

            countryRep = countryType.titleStr(G(db.country, G(record, N.country)))
            yearRep = yearType.titleStr(G(db.year, G(record, N.year)))
            typeRep = typeType.titleStr(G(db.typeContribution, G(record, N.type)))
            cost = G(record, N.cost)

            contribs[contribId] = {
                N._id: contribId,
                N._cn: countryRep,
                N.country: countryRep,
                N.year: yearRep,
                N.type: typeRep,
                N.title: title,
                N.cost: cost,
                N.assessed: assessed,
                N.arank: aRank,
                N.astage: aStage,
                N.score: score,
                N.selected: selected,
            }

        self.contribs = contribs

    def roTri(self, tri):
        return self.bool3Obj.toDisplay(tri, markup=False)

    def wrap(self, asTsv=False):
        context = self.context
        db = context.db
        auth = context.auth
        countryType = self.countryType

        self.isSuperUser = auth.superuser()
        self.isCoord = auth.coordinator()

        colSpecs = COLSPECS
        groupCols = GROUP_COLS
        allGroupSet = set(groupCols)

        accessRep = auth.credentials()[1]

        rawSortCol = request.args.get(N.sortcol, E)
        rawReverse = request.args.get(N.reverse, E)
        country = request.args.get(N.country, E)
        groups = COMMA.join(
            g for g in request.args.get(N.groups, E).split(COMMA) if g in allGroupSet
        )

        self.getCountry(country)
        self.getContribs()

        chosenCountry = self.chosenCountry
        chosenCountryId = self.chosenCountryId
        chosenCountryIso = self.chosenCountryIso

        if chosenCountryId is not None:
            colSpecs = COLSPECS[1:]
            groups = self.rmGroup(groups.split(COMMA), N.country)
            groupCols = GROUP_COLS[1:]

        cols = [c[0] for c in colSpecs]
        colSet = {c[0] for c in colSpecs}

        self.types = dict((c[0], c[1]) for c in colSpecs)
        labels = dict((c[0], c[2] if len(c) &gt; 2 else c[0]) for c in colSpecs)
        sortDefault = cols[-1]

        groupsChosen = [] if not groups else groups.split(COMMA)
        groupSet = set(groupsChosen)
        groupStr = (&#34;&#34;&#34;-by-&#34;&#34;&#34; if groupSet else E) + MIN.join(sorted(groupSet))

        sortCol = sortDefault if rawSortCol not in colSet else rawSortCol
        reverse = False if rawReverse not in {MINONE, ONE} else rawReverse == MINONE

        self.cols = cols
        self.labels = labels
        self.groupCols = groupCols
        self.sortCol = sortCol
        self.reverse = reverse

        material = []
        if not asTsv:
            material.append(H.h(3, &#34;&#34;&#34;Country selection&#34;&#34;&#34;))

            countryItems = [
                H.a(
                    ALL,
                    (
                        f&#34;&#34;&#34;{PAGE}?country=x&amp;sortcol={rawSortCol}&amp;&#34;&#34;&#34;
                        f&#34;&#34;&#34;reverse={rawReverse}&amp;groups={groups}&#34;&#34;&#34;
                    ),
                    cls=&#34;c-control&#34;,
                )
                if chosenCountryId
                else H.span(ALL, cls=&#34;c-focus&#34;)
            ]
            for (cid, countryInfo) in db.country.items():
                if not G(countryInfo, N.isMember):
                    continue
                name = countryType.titleStr(countryInfo)
                iso = G(countryInfo, N.iso)

                countryItems.append(
                    H.span(name, cls=&#34;c-focus&#34;)
                    if cid == chosenCountryId
                    else H.a(
                        name,
                        (
                            f&#34;&#34;&#34;{PAGE}?country={iso}&amp;sortcol={rawSortCol}&amp;&#34;&#34;&#34;
                            f&#34;&#34;&#34;reverse={rawReverse}&amp;groups={groups}&#34;&#34;&#34;
                        ),
                        cls=&#34;c-control&#34;,
                    )
                )
            material.append(H.p(countryItems, cls=N.countries))

        groupsAvailable = sorted(allGroupSet - set(groupsChosen))
        groupOrder = groupsChosen + [g for g in cols if g not in groupSet]

        if not asTsv:
            urlArgs = (
                f&#34;&#34;&#34;?country={chosenCountryIso}&amp;&#34;&#34;&#34;
                f&#34;&#34;&#34;sortcol={rawSortCol}&amp;reverse={rawReverse}&amp;&#34;&#34;&#34;
            )
            urlStart1 = f&#34;&#34;&#34;{PAGE}{urlArgs}&#34;&#34;&#34;
            urlStart = f&#34;&#34;&#34;{urlStart1}&#34;&#34;&#34; f&#34;&amp;groups=&#34;
            availableReps = E.join(
                H.a(
                    f&#34;&#34;&#34;+{g}&#34;&#34;&#34;,
                    (f&#34;&#34;&#34;{urlStart}{self.addGroup(groupsChosen, g)}&#34;&#34;&#34;),
                    cls=&#34;g-add&#34;,
                )
                for g in groupsAvailable
            )
            chosenReps = E.join(
                H.a(
                    f&#34;&#34;&#34;-{g}&#34;&#34;&#34;,
                    f&#34;&#34;&#34;{urlStart}{self.rmGroup(groupsChosen, g)}&#34;&#34;&#34;,
                    cls=&#34;g-rm&#34;,
                )
                for g in groupsChosen
            )
            clearGroups = (
                E
                if len(chosenReps) == 0
                else H.iconx(
                    N.clear, urlStart1, cls=&#34;g-x&#34;, title=&#34;&#34;&#34;clear all groups&#34;&#34;&#34;
                )
            )
            rArgs = f&#34;&#34;&#34;{urlArgs}groups={groups}&#34;&#34;&#34;

        headerLine = self.ourCountryHeaders(
            country, groups, asTsv, groupOrder=groupOrder,
        )

        contribs = self.contribs
        nContribs = len(contribs)
        plural = E if nContribs == 1 else S
        things = f&#34;&#34;&#34;{len(contribs)} contribution{plural}&#34;&#34;&#34;
        origin = chosenCountry or ALL.lower()

        if not asTsv:
            material.append(H.h(3, &#34;&#34;&#34;Grouping&#34;&#34;&#34;))
            material.append(
                H.table(
                    [],
                    [
                        (
                            [
                                (&#34;&#34;&#34;available groups&#34;&#34;&#34;, dict(cls=&#34;mtl&#34;)),
                                (availableReps, dict(cls=&#34;mtd&#34;)),
                                (NBSP, {}),
                            ],
                            {},
                        ),
                        (
                            [
                                (&#34;&#34;&#34;chosen groups&#34;&#34;&#34;, dict(cls=&#34;mtl&#34;)),
                                (chosenReps, dict(cls=&#34;mtd&#34;)),
                                (clearGroups, {}),
                            ],
                            {},
                        ),
                    ],
                    cls=&#34;mt&#34;,
                )
            )
            material.append(
                H.h(
                    3,
                    [
                        f&#34;&#34;&#34;{things} from {origin}&#34;&#34;&#34;,
                        H.a(
                            &#34;&#34;&#34;Download as Excel&#34;&#34;&#34;,
                            f&#34;&#34;&#34;{PAGEX}{rArgs}&#34;&#34;&#34;,
                            target=&#34;_blank&#34;,
                            cls=&#34;button large&#34;,
                        ),
                    ],
                )
            )

        (thisMaterial, groupRel) = self.groupList(
            groupsChosen, chosenCountry, chosenCountry, asTsv,
        )

        if asTsv:
            material.append(thisMaterial)
        else:
            material.append(H.table([headerLine], thisMaterial, cls=&#34;cc&#34;))
            material.append(groupRel)

        if asTsv:
            fileName = (
                f&#34;&#34;&#34;dariah-{country or &#34;all-countries&#34;}{groupStr}-for-{accessRep}&#34;&#34;&#34;
            )
            headers = {
                &#34;Expires&#34;: &#34;0&#34;,
                &#34;Cache-Control&#34;: &#34;no-cache, no-store, must-revalidate&#34;,
                &#34;Content-Type&#34;: &#34;text/csv&#34;,
                &#34;Content-Disposition&#34;: f&#39;attachment; filename=&#34;{fileName}&#34;&#39;,
                &#34;Content-Encoding&#34;: &#34;identity&#34;,
            }
            tsv = f&#34;&#34;&#34;\ufeff{headerLine}\n{NL.join(material)}&#34;&#34;&#34;.encode(&#34;&#34;&#34;utf_16_le&#34;&#34;&#34;)
            data = make_response(tsv, headers)
        else:
            data = E.join(material)

        return data

    def groupList(
        self, groups, selectedCountry, chosenCountry, asTsv,
    ):
        cols = self.cols
        groupCols = self.groupCols
        contribs = self.contribs
        sortCol = self.sortCol
        reverse = self.reverse

        if len(groups) == 0:
            groupedList = sorted(
                contribs.values(), key=self.contribKey(sortCol), reverse=reverse
            )
            if asTsv:
                return (
                    NL.join(
                        self.formatContrib(contrib, None, chosenCountry, asTsv,)
                        for contrib in groupedList
                    ),
                    E,
                )
            else:
                return (
                    [
                        self.formatContrib(contrib, None, chosenCountry, asTsv,)
                        for contrib in groupedList
                    ],
                    E,
                )

        preGroups = groups[0:-1]
        lastGroup = groups[-1]

        groupLen = len(groups)
        groupSet = set(groups)
        groupOrder = groups + [g for g in cols if g not in groupSet]

        groupedList = {}

        for c in contribs.values():
            dest = groupedList
            for g in preGroups:
                dest = dest.setdefault(G(c, g), {})
            dest = dest.setdefault(G(c, lastGroup), [])
            dest.append(c)

        material = []
        maxGroupId = 1
        groupRel = {}

        def groupMaterial(gList, depth, groupValues, parentGroupId):
            groupSet = set(groupValues.keys())

            nonlocal maxGroupId
            maxGroupId += 1
            thisGroupId = maxGroupId
            thisGroupId = COMMA.join(f&#34;&#34;&#34;{k}:{v}&#34;&#34;&#34; for (k, v) in groupValues.items())
            groupRel.setdefault(str(parentGroupId), []).append(str(thisGroupId))

            headIndex = len(material)
            material.append(MIN if asTsv else ([(MIN, {})], {}))
            nRecords = 0
            nGroups = 0
            cost = 0
            if type(gList) is list:
                for rec in sorted(
                    (
                        {k: v for (k, v) in list(d.items()) if k not in groupValues}
                        for d in gList
                    ),
                    key=self.contribKey(sortCol),
                    reverse=reverse,
                ):
                    nRecords += 1
                    nGroups += 1
                    cost += G(rec, N.cost) or 0
                    material.append(
                        self.formatContrib(
                            rec,
                            thisGroupId,
                            chosenCountry,
                            asTsv,
                            groupOrder=groupOrder,
                            hide=True,
                        )
                    )
            else:
                newGroup = groups[depth]
                for groupValue in sorted(
                    gList.keys(),
                    key=self.contribKey(newGroup, individual=True),
                    reverse=reverse,
                ):
                    nGroups += 1
                    newGroupValues = {}
                    newGroupValues.update(groupValues)
                    newGroupValues[newGroup] = groupValue
                    (nRecordsG, costG) = groupMaterial(
                        gList[groupValue], depth + 1, newGroupValues, thisGroupId,
                    )
                    nRecords += nRecordsG
                    cost += costG
            groupValuesT = {}
            if depth &gt; 0:
                thisGroup = groups[depth - 1]
                groupValuesT[thisGroup] = groupValues[thisGroup]
            # groupValuesT.update(groupValues)
            groupValuesT[N.cost] = cost
            groupValuesT[N.title] = self.colRep(N.contribution, nRecords)
            groupValuesT[N._cn] = G(groupValues, N.country)
            if depth == 0:
                for g in groupCols + [N.title]:
                    label = selectedCountry if g == N.country else N.all
                    controls = (
                        self.expandAcontrols(g) if g in groups or g == N.title else E
                    )
                    groupValuesT[g] = label if asTsv else f&#34;&#34;&#34;{label} {controls}&#34;&#34;&#34;
            material[headIndex] = self.formatContrib(
                groupValuesT,
                parentGroupId,
                chosenCountry,
                asTsv,
                groupOrder=groupOrder,
                groupSet=groupSet,
                subHead=True,
                allHead=depth == 0,
                groupLen=groupLen,
                depth=depth,
                thisGroupId=thisGroupId,
                nGroups=nGroups,
            )
            return (nRecords, cost)

        groupMaterial(groupedList, 0, {}, 1)
        return (
            NL.join(material) if asTsv else material,
            H.script(f&#34;&#34;&#34;var groupRel = {json.dumps(groupRel)}&#34;&#34;&#34;),
        )

    def formatContrib(
        self,
        contrib,
        groupId,
        chosenCountry,
        asTsv,
        groupOrder=None,
        groupSet=set(),
        subHead=False,
        allHead=False,
        groupLen=None,
        depth=None,
        thisGroupId=None,
        nGroups=None,
        hide=False,
    ):
        cols = self.cols

        if groupOrder is None:
            groupOrder = cols
        contribId = G(contrib, N._id)
        (assessedLabel, assessedClass) = self.wrapStatus(contrib, subHead=subHead)
        if allHead:
            selected = G(contrib, N.selected) or E
            if asTsv:
                selected = self.valTri(selected)
            assessedClass = E
        else:
            selected = G(contrib, N.selected)
            selected = (
                (self.valTri(selected) if asTsv else self.roTri(selected))
                if N.selected in contrib
                else E
            )
        rawTitle = G(contrib, N.title) or E
        title = (
            rawTitle
            if asTsv
            else rawTitle
            if subHead
            else H.a(
                f&#34;&#34;&#34;{rawTitle or &#34;? missing title ?&#34;}&#34;&#34;&#34;,
                f&#34;&#34;&#34;/{N.contrib}/{N.item}/{contribId}&#34;&#34;&#34;,
            )
            if N.title in contrib
            else E
        )

        values = {
            N.country: G(contrib, N.country) or E,
            N.year: G(contrib, N.year) or E,
            N.type: G(contrib, N.type) or E,
            N.cost: self.euro(G(contrib, N.cost)),
            N.assessed: assessedLabel,
            N.selected: selected,
            N.title: title,
        }
        recCountry = G(contrib, N._cn) or G(values, N.country)
        if depth is not None:
            xGroup = groupOrder[depth] if depth == 0 or depth &lt; groupLen else N.title
            xName = N.contribution if xGroup == N.title else xGroup
            xRep = self.colRep(xName, nGroups)
            values[xGroup] = (
                xRep
                if asTsv
                else (
                    f&#34;&#34;&#34;{self.expandControls(thisGroupId, True)} {xRep}&#34;&#34;&#34;
                    if xGroup == N.title
                    else f&#34;&#34;&#34;{values[xGroup]} ({xRep}) {self.expandControls(thisGroupId)}&#34;&#34;&#34;
                    if depth &gt; 0
                    else f&#34;&#34;&#34;{values[xGroup]} ({xRep}) {self.expandControls(thisGroupId)}&#34;&#34;&#34;
                )
            )
        if not asTsv:
            classes = {col: f&#34;c-{col}&#34; for col in groupOrder}
            classes[&#34;assessed&#34;] += f&#34; {assessedClass}&#34;
        if asTsv:
            columns = TAB.join(
                self.disclose(values, col, recCountry) or E for col in groupOrder
            )
        else:
            columns = [
                (
                    self.disclose(values, col, recCountry),
                    dict(
                        cls=(
                            f&#34;{classes[col]} &#34;
                            + self.subHeadClass(col, groupSet, subHead, allHead)
                        )
                    ),
                )
                for col in groupOrder
            ]
        if not asTsv:
            hideRep = &#34; hide&#34; if hide else E
            displayAtts = (
                {} if groupId is None else dict(cls=f&#34;dd{hideRep}&#34;, gid=groupId)
            )
        return columns if asTsv else (columns, displayAtts)

    def contribKey(self, col, individual=False):
        types = self.types

        colType = types[col]

        def makeKey(contrib):
            if col == N.assessed:
                return G(contrib, N.arank)
            value = G(contrib, col)
            if value is None:
                return E if colType is str else 0
            if colType is str:
                return value.lower()
            if colType is bool:
                return 1 if value else -1
            return value

        def makeKeyInd(value):
            if col == N.assessed:
                return value
            if value is None:
                return E if colType is str else 0
            if colType is str:
                return value.lower()
            if colType is bool:
                return 1 if value else -1
            return value

        return makeKeyInd if individual else makeKey

    def ourCountryHeaders(self, country, groups, asTsv, groupOrder=None):
        cols = self.cols
        labels = self.labels
        sortCol = self.sortCol
        reverse = self.reverse

        if groupOrder is None:
            groupOrder = cols

        if asTsv:
            headers = E
            sep = E
            for col in groupOrder:
                label = labels[col]
                colControl = label
                headers += f&#34;&#34;&#34;{sep}{colControl}&#34;&#34;&#34;
                sep = TAB

        else:
            headers = []
            dirClass = N.desc if reverse else N.asc
            dirIcon = N.adown if reverse else N.aup
            urlStart = f&#34;&#34;&#34;{PAGE}?country={country}&amp;groups={groups}&amp;&#34;&#34;&#34;
            for col in groupOrder:
                isSorted = col == sortCol
                thisClass = f&#34;c-{col}&#34;
                icon = E
                if isSorted:
                    thisClass += f&#34; {dirClass}&#34;
                    nextReverse = not reverse
                    icon = H.iconx(dirIcon)
                else:
                    nextReverse = False
                reverseRep = -1 if nextReverse else 1
                label = labels[col]
                sep = NBSP if icon else E
                colControl = H.a(
                    f&#34;&#34;&#34;{label}{icon}&#34;&#34;&#34;,
                    f&#34;&#34;&#34;{urlStart}sortcol={col}&amp;reverse={reverseRep}&#34;&#34;&#34;,
                )
                headers.append((colControl, dict(cls=f&#34;och {thisClass}&#34;)))
            headers = (headers, {})

        return headers

    def disclose(self, values, colName, recCountry):
        context = self.context
        auth = context.auth
        isSuperUser = self.isSuperUser
        isCoord = auth.coordinator(countryId=recCountry)

        disclosed = colName != N.cost or isSuperUser or isCoord
        value = values[colName] if disclosed else N.undisclosed
        return value

    @staticmethod
    def wrapStatus(contrib, subHead=False):
        aStage = G(contrib, N.astage)
        assessed = G(contrib, N.assessed) or E
        score = G(contrib, N.score)
        scoreRep = E if score is None else f&#34;&#34;&#34;{score}% - &#34;&#34;&#34;
        baseLabel = assessed if subHead else G(ASSESSED_LABELS, aStage, default=E)
        aClass = (
            G(ASSESSED_CLASS1, assessed, default=ASSESSED_ACCEPTED_CLASS)
            if subHead
            else G(ASSESSED_CLASS, aStage, default=ASSESSED_ACCEPTED_CLASS)
        )
        aLabel = baseLabel if subHead else f&#34;&#34;&#34;{scoreRep}{baseLabel}&#34;&#34;&#34;
        return (aLabel, aClass)

    @staticmethod
    def colRep(col, n):
        itemRep = col if n == 1 else G(COL_PLURAL, col, default=f&#34;&#34;&#34;{col}s&#34;&#34;&#34;)
        return f&#34;&#34;&#34;{n} {itemRep}&#34;&#34;&#34;

    @staticmethod
    def addGroup(groups, g):
        return COMMA.join(groups + [g])

    @staticmethod
    def rmGroup(groups, g):
        return COMMA.join(h for h in groups if h != g)

    @staticmethod
    def expandControls(gid, hide=False):
        hideRep = &#34; hide&#34; if hide else E
        showRep = E if hide else &#34; hide&#34;
        return E.join(
            (
                H.iconx(N.cdown, href=E, cls=f&#34;&#34;&#34;dc{showRep}&#34;&#34;&#34;, gid=gid),
                H.iconx(N.cup, href=E, cls=f&#34;&#34;&#34;dc{hideRep}&#34;&#34;&#34;, gid=gid),
            )
        )

    @staticmethod
    def expandAcontrols(group):
        return E.join(
            (
                H.iconx(N.addown, href=E, cls=f&#34;dca&#34;, gn=group),
                H.iconx(N.adup, href=E, cls=f&#34;dca&#34;, gn=group),
            )
        )

    @staticmethod
    def euro(amount):
        return E if amount is None else f&#34;&#34;&#34;{int(round(amount)):,}&#34;&#34;&#34;

    @staticmethod
    def valTri(tri):
        return E if tri is None else PLUS if tri else MIN

    @staticmethod
    def subHeadClass(col, groupSet, subHead, allHead):
        theClass = (
            &#34;allhead&#34;
            if allHead and col == N.selected
            else &#34;subhead&#34;
            if allHead or (subHead and (col in groupSet or col in SUBHEAD_X_COLS))
            else E
        )
        return f&#34; {theClass}&#34; if theClass else E</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-classes">Classes</h2>
<dl>
<dt id="control.overview.Overview"><code class="flex name class">
<span>class <span class="ident">Overview</span></span>
<span>(</span><span>context)</span>
</code></dt>
<dd>
<section class="desc"></section>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class Overview:
    def __init__(self, context):
        self.context = context

        types = context.types
        self.bool3Obj = types.bool3
        self.countryType = types.country
        self.yearType = types.year
        self.typeType = types.typeContribution

    def getCountry(self, country):
        context = self.context
        db = context.db
        auth = context.auth
        user = auth.user
        countryType = self.countryType

        self.userGroup = auth.groupRep()
        self.myCountry = auth.countryRep()

        userCountryId = G(user, N.country)
        chosenCountry = None
        chosenCountryIso = None
        chosenCountryId = None

        countryId = G(db.countryInv, country) if country else userCountryId

        if countryId is not None:
            chosenCountryId = countryId
            countryInfo = G(db.country, chosenCountryId, default={})
            chosenCountry = countryType.titleStr(countryInfo)
            chosenCountryIso = G(countryInfo, N.iso)

        self.chosenCountry = chosenCountry
        self.chosenCountryId = chosenCountryId
        self.chosenCountryIso = chosenCountryIso

    def getContribs(self):
        context = self.context
        db = context.db
        chosenCountryId = self.chosenCountryId
        countryType = self.countryType
        yearType = self.yearType
        typeType = self.typeType

        contribs = {}
        for record in db.bulkContribWorkflow(chosenCountryId):
            title = G(record, N.title)
            contribId = G(record, N._id)

            selected = G(record, N.selected)
            aStage = G(record, N.aStage)
            rStage = G(record, N.rStage)
            if rStage in {N.reviewAccept, N.reviewReject}:
                aStage = rStage
            score = G(record, N.score)
            assessed = ASSESSED_STATUS[aStage][0]
            aRank = (G(ASSESSED_RANK, aStage, default=0), score)
            if aStage != N.reviewAccept:
                score = None

            countryRep = countryType.titleStr(G(db.country, G(record, N.country)))
            yearRep = yearType.titleStr(G(db.year, G(record, N.year)))
            typeRep = typeType.titleStr(G(db.typeContribution, G(record, N.type)))
            cost = G(record, N.cost)

            contribs[contribId] = {
                N._id: contribId,
                N._cn: countryRep,
                N.country: countryRep,
                N.year: yearRep,
                N.type: typeRep,
                N.title: title,
                N.cost: cost,
                N.assessed: assessed,
                N.arank: aRank,
                N.astage: aStage,
                N.score: score,
                N.selected: selected,
            }

        self.contribs = contribs

    def roTri(self, tri):
        return self.bool3Obj.toDisplay(tri, markup=False)

    def wrap(self, asTsv=False):
        context = self.context
        db = context.db
        auth = context.auth
        countryType = self.countryType

        self.isSuperUser = auth.superuser()
        self.isCoord = auth.coordinator()

        colSpecs = COLSPECS
        groupCols = GROUP_COLS
        allGroupSet = set(groupCols)

        accessRep = auth.credentials()[1]

        rawSortCol = request.args.get(N.sortcol, E)
        rawReverse = request.args.get(N.reverse, E)
        country = request.args.get(N.country, E)
        groups = COMMA.join(
            g for g in request.args.get(N.groups, E).split(COMMA) if g in allGroupSet
        )

        self.getCountry(country)
        self.getContribs()

        chosenCountry = self.chosenCountry
        chosenCountryId = self.chosenCountryId
        chosenCountryIso = self.chosenCountryIso

        if chosenCountryId is not None:
            colSpecs = COLSPECS[1:]
            groups = self.rmGroup(groups.split(COMMA), N.country)
            groupCols = GROUP_COLS[1:]

        cols = [c[0] for c in colSpecs]
        colSet = {c[0] for c in colSpecs}

        self.types = dict((c[0], c[1]) for c in colSpecs)
        labels = dict((c[0], c[2] if len(c) &gt; 2 else c[0]) for c in colSpecs)
        sortDefault = cols[-1]

        groupsChosen = [] if not groups else groups.split(COMMA)
        groupSet = set(groupsChosen)
        groupStr = (&#34;&#34;&#34;-by-&#34;&#34;&#34; if groupSet else E) + MIN.join(sorted(groupSet))

        sortCol = sortDefault if rawSortCol not in colSet else rawSortCol
        reverse = False if rawReverse not in {MINONE, ONE} else rawReverse == MINONE

        self.cols = cols
        self.labels = labels
        self.groupCols = groupCols
        self.sortCol = sortCol
        self.reverse = reverse

        material = []
        if not asTsv:
            material.append(H.h(3, &#34;&#34;&#34;Country selection&#34;&#34;&#34;))

            countryItems = [
                H.a(
                    ALL,
                    (
                        f&#34;&#34;&#34;{PAGE}?country=x&amp;sortcol={rawSortCol}&amp;&#34;&#34;&#34;
                        f&#34;&#34;&#34;reverse={rawReverse}&amp;groups={groups}&#34;&#34;&#34;
                    ),
                    cls=&#34;c-control&#34;,
                )
                if chosenCountryId
                else H.span(ALL, cls=&#34;c-focus&#34;)
            ]
            for (cid, countryInfo) in db.country.items():
                if not G(countryInfo, N.isMember):
                    continue
                name = countryType.titleStr(countryInfo)
                iso = G(countryInfo, N.iso)

                countryItems.append(
                    H.span(name, cls=&#34;c-focus&#34;)
                    if cid == chosenCountryId
                    else H.a(
                        name,
                        (
                            f&#34;&#34;&#34;{PAGE}?country={iso}&amp;sortcol={rawSortCol}&amp;&#34;&#34;&#34;
                            f&#34;&#34;&#34;reverse={rawReverse}&amp;groups={groups}&#34;&#34;&#34;
                        ),
                        cls=&#34;c-control&#34;,
                    )
                )
            material.append(H.p(countryItems, cls=N.countries))

        groupsAvailable = sorted(allGroupSet - set(groupsChosen))
        groupOrder = groupsChosen + [g for g in cols if g not in groupSet]

        if not asTsv:
            urlArgs = (
                f&#34;&#34;&#34;?country={chosenCountryIso}&amp;&#34;&#34;&#34;
                f&#34;&#34;&#34;sortcol={rawSortCol}&amp;reverse={rawReverse}&amp;&#34;&#34;&#34;
            )
            urlStart1 = f&#34;&#34;&#34;{PAGE}{urlArgs}&#34;&#34;&#34;
            urlStart = f&#34;&#34;&#34;{urlStart1}&#34;&#34;&#34; f&#34;&amp;groups=&#34;
            availableReps = E.join(
                H.a(
                    f&#34;&#34;&#34;+{g}&#34;&#34;&#34;,
                    (f&#34;&#34;&#34;{urlStart}{self.addGroup(groupsChosen, g)}&#34;&#34;&#34;),
                    cls=&#34;g-add&#34;,
                )
                for g in groupsAvailable
            )
            chosenReps = E.join(
                H.a(
                    f&#34;&#34;&#34;-{g}&#34;&#34;&#34;,
                    f&#34;&#34;&#34;{urlStart}{self.rmGroup(groupsChosen, g)}&#34;&#34;&#34;,
                    cls=&#34;g-rm&#34;,
                )
                for g in groupsChosen
            )
            clearGroups = (
                E
                if len(chosenReps) == 0
                else H.iconx(
                    N.clear, urlStart1, cls=&#34;g-x&#34;, title=&#34;&#34;&#34;clear all groups&#34;&#34;&#34;
                )
            )
            rArgs = f&#34;&#34;&#34;{urlArgs}groups={groups}&#34;&#34;&#34;

        headerLine = self.ourCountryHeaders(
            country, groups, asTsv, groupOrder=groupOrder,
        )

        contribs = self.contribs
        nContribs = len(contribs)
        plural = E if nContribs == 1 else S
        things = f&#34;&#34;&#34;{len(contribs)} contribution{plural}&#34;&#34;&#34;
        origin = chosenCountry or ALL.lower()

        if not asTsv:
            material.append(H.h(3, &#34;&#34;&#34;Grouping&#34;&#34;&#34;))
            material.append(
                H.table(
                    [],
                    [
                        (
                            [
                                (&#34;&#34;&#34;available groups&#34;&#34;&#34;, dict(cls=&#34;mtl&#34;)),
                                (availableReps, dict(cls=&#34;mtd&#34;)),
                                (NBSP, {}),
                            ],
                            {},
                        ),
                        (
                            [
                                (&#34;&#34;&#34;chosen groups&#34;&#34;&#34;, dict(cls=&#34;mtl&#34;)),
                                (chosenReps, dict(cls=&#34;mtd&#34;)),
                                (clearGroups, {}),
                            ],
                            {},
                        ),
                    ],
                    cls=&#34;mt&#34;,
                )
            )
            material.append(
                H.h(
                    3,
                    [
                        f&#34;&#34;&#34;{things} from {origin}&#34;&#34;&#34;,
                        H.a(
                            &#34;&#34;&#34;Download as Excel&#34;&#34;&#34;,
                            f&#34;&#34;&#34;{PAGEX}{rArgs}&#34;&#34;&#34;,
                            target=&#34;_blank&#34;,
                            cls=&#34;button large&#34;,
                        ),
                    ],
                )
            )

        (thisMaterial, groupRel) = self.groupList(
            groupsChosen, chosenCountry, chosenCountry, asTsv,
        )

        if asTsv:
            material.append(thisMaterial)
        else:
            material.append(H.table([headerLine], thisMaterial, cls=&#34;cc&#34;))
            material.append(groupRel)

        if asTsv:
            fileName = (
                f&#34;&#34;&#34;dariah-{country or &#34;all-countries&#34;}{groupStr}-for-{accessRep}&#34;&#34;&#34;
            )
            headers = {
                &#34;Expires&#34;: &#34;0&#34;,
                &#34;Cache-Control&#34;: &#34;no-cache, no-store, must-revalidate&#34;,
                &#34;Content-Type&#34;: &#34;text/csv&#34;,
                &#34;Content-Disposition&#34;: f&#39;attachment; filename=&#34;{fileName}&#34;&#39;,
                &#34;Content-Encoding&#34;: &#34;identity&#34;,
            }
            tsv = f&#34;&#34;&#34;\ufeff{headerLine}\n{NL.join(material)}&#34;&#34;&#34;.encode(&#34;&#34;&#34;utf_16_le&#34;&#34;&#34;)
            data = make_response(tsv, headers)
        else:
            data = E.join(material)

        return data

    def groupList(
        self, groups, selectedCountry, chosenCountry, asTsv,
    ):
        cols = self.cols
        groupCols = self.groupCols
        contribs = self.contribs
        sortCol = self.sortCol
        reverse = self.reverse

        if len(groups) == 0:
            groupedList = sorted(
                contribs.values(), key=self.contribKey(sortCol), reverse=reverse
            )
            if asTsv:
                return (
                    NL.join(
                        self.formatContrib(contrib, None, chosenCountry, asTsv,)
                        for contrib in groupedList
                    ),
                    E,
                )
            else:
                return (
                    [
                        self.formatContrib(contrib, None, chosenCountry, asTsv,)
                        for contrib in groupedList
                    ],
                    E,
                )

        preGroups = groups[0:-1]
        lastGroup = groups[-1]

        groupLen = len(groups)
        groupSet = set(groups)
        groupOrder = groups + [g for g in cols if g not in groupSet]

        groupedList = {}

        for c in contribs.values():
            dest = groupedList
            for g in preGroups:
                dest = dest.setdefault(G(c, g), {})
            dest = dest.setdefault(G(c, lastGroup), [])
            dest.append(c)

        material = []
        maxGroupId = 1
        groupRel = {}

        def groupMaterial(gList, depth, groupValues, parentGroupId):
            groupSet = set(groupValues.keys())

            nonlocal maxGroupId
            maxGroupId += 1
            thisGroupId = maxGroupId
            thisGroupId = COMMA.join(f&#34;&#34;&#34;{k}:{v}&#34;&#34;&#34; for (k, v) in groupValues.items())
            groupRel.setdefault(str(parentGroupId), []).append(str(thisGroupId))

            headIndex = len(material)
            material.append(MIN if asTsv else ([(MIN, {})], {}))
            nRecords = 0
            nGroups = 0
            cost = 0
            if type(gList) is list:
                for rec in sorted(
                    (
                        {k: v for (k, v) in list(d.items()) if k not in groupValues}
                        for d in gList
                    ),
                    key=self.contribKey(sortCol),
                    reverse=reverse,
                ):
                    nRecords += 1
                    nGroups += 1
                    cost += G(rec, N.cost) or 0
                    material.append(
                        self.formatContrib(
                            rec,
                            thisGroupId,
                            chosenCountry,
                            asTsv,
                            groupOrder=groupOrder,
                            hide=True,
                        )
                    )
            else:
                newGroup = groups[depth]
                for groupValue in sorted(
                    gList.keys(),
                    key=self.contribKey(newGroup, individual=True),
                    reverse=reverse,
                ):
                    nGroups += 1
                    newGroupValues = {}
                    newGroupValues.update(groupValues)
                    newGroupValues[newGroup] = groupValue
                    (nRecordsG, costG) = groupMaterial(
                        gList[groupValue], depth + 1, newGroupValues, thisGroupId,
                    )
                    nRecords += nRecordsG
                    cost += costG
            groupValuesT = {}
            if depth &gt; 0:
                thisGroup = groups[depth - 1]
                groupValuesT[thisGroup] = groupValues[thisGroup]
            # groupValuesT.update(groupValues)
            groupValuesT[N.cost] = cost
            groupValuesT[N.title] = self.colRep(N.contribution, nRecords)
            groupValuesT[N._cn] = G(groupValues, N.country)
            if depth == 0:
                for g in groupCols + [N.title]:
                    label = selectedCountry if g == N.country else N.all
                    controls = (
                        self.expandAcontrols(g) if g in groups or g == N.title else E
                    )
                    groupValuesT[g] = label if asTsv else f&#34;&#34;&#34;{label} {controls}&#34;&#34;&#34;
            material[headIndex] = self.formatContrib(
                groupValuesT,
                parentGroupId,
                chosenCountry,
                asTsv,
                groupOrder=groupOrder,
                groupSet=groupSet,
                subHead=True,
                allHead=depth == 0,
                groupLen=groupLen,
                depth=depth,
                thisGroupId=thisGroupId,
                nGroups=nGroups,
            )
            return (nRecords, cost)

        groupMaterial(groupedList, 0, {}, 1)
        return (
            NL.join(material) if asTsv else material,
            H.script(f&#34;&#34;&#34;var groupRel = {json.dumps(groupRel)}&#34;&#34;&#34;),
        )

    def formatContrib(
        self,
        contrib,
        groupId,
        chosenCountry,
        asTsv,
        groupOrder=None,
        groupSet=set(),
        subHead=False,
        allHead=False,
        groupLen=None,
        depth=None,
        thisGroupId=None,
        nGroups=None,
        hide=False,
    ):
        cols = self.cols

        if groupOrder is None:
            groupOrder = cols
        contribId = G(contrib, N._id)
        (assessedLabel, assessedClass) = self.wrapStatus(contrib, subHead=subHead)
        if allHead:
            selected = G(contrib, N.selected) or E
            if asTsv:
                selected = self.valTri(selected)
            assessedClass = E
        else:
            selected = G(contrib, N.selected)
            selected = (
                (self.valTri(selected) if asTsv else self.roTri(selected))
                if N.selected in contrib
                else E
            )
        rawTitle = G(contrib, N.title) or E
        title = (
            rawTitle
            if asTsv
            else rawTitle
            if subHead
            else H.a(
                f&#34;&#34;&#34;{rawTitle or &#34;? missing title ?&#34;}&#34;&#34;&#34;,
                f&#34;&#34;&#34;/{N.contrib}/{N.item}/{contribId}&#34;&#34;&#34;,
            )
            if N.title in contrib
            else E
        )

        values = {
            N.country: G(contrib, N.country) or E,
            N.year: G(contrib, N.year) or E,
            N.type: G(contrib, N.type) or E,
            N.cost: self.euro(G(contrib, N.cost)),
            N.assessed: assessedLabel,
            N.selected: selected,
            N.title: title,
        }
        recCountry = G(contrib, N._cn) or G(values, N.country)
        if depth is not None:
            xGroup = groupOrder[depth] if depth == 0 or depth &lt; groupLen else N.title
            xName = N.contribution if xGroup == N.title else xGroup
            xRep = self.colRep(xName, nGroups)
            values[xGroup] = (
                xRep
                if asTsv
                else (
                    f&#34;&#34;&#34;{self.expandControls(thisGroupId, True)} {xRep}&#34;&#34;&#34;
                    if xGroup == N.title
                    else f&#34;&#34;&#34;{values[xGroup]} ({xRep}) {self.expandControls(thisGroupId)}&#34;&#34;&#34;
                    if depth &gt; 0
                    else f&#34;&#34;&#34;{values[xGroup]} ({xRep}) {self.expandControls(thisGroupId)}&#34;&#34;&#34;
                )
            )
        if not asTsv:
            classes = {col: f&#34;c-{col}&#34; for col in groupOrder}
            classes[&#34;assessed&#34;] += f&#34; {assessedClass}&#34;
        if asTsv:
            columns = TAB.join(
                self.disclose(values, col, recCountry) or E for col in groupOrder
            )
        else:
            columns = [
                (
                    self.disclose(values, col, recCountry),
                    dict(
                        cls=(
                            f&#34;{classes[col]} &#34;
                            + self.subHeadClass(col, groupSet, subHead, allHead)
                        )
                    ),
                )
                for col in groupOrder
            ]
        if not asTsv:
            hideRep = &#34; hide&#34; if hide else E
            displayAtts = (
                {} if groupId is None else dict(cls=f&#34;dd{hideRep}&#34;, gid=groupId)
            )
        return columns if asTsv else (columns, displayAtts)

    def contribKey(self, col, individual=False):
        types = self.types

        colType = types[col]

        def makeKey(contrib):
            if col == N.assessed:
                return G(contrib, N.arank)
            value = G(contrib, col)
            if value is None:
                return E if colType is str else 0
            if colType is str:
                return value.lower()
            if colType is bool:
                return 1 if value else -1
            return value

        def makeKeyInd(value):
            if col == N.assessed:
                return value
            if value is None:
                return E if colType is str else 0
            if colType is str:
                return value.lower()
            if colType is bool:
                return 1 if value else -1
            return value

        return makeKeyInd if individual else makeKey

    def ourCountryHeaders(self, country, groups, asTsv, groupOrder=None):
        cols = self.cols
        labels = self.labels
        sortCol = self.sortCol
        reverse = self.reverse

        if groupOrder is None:
            groupOrder = cols

        if asTsv:
            headers = E
            sep = E
            for col in groupOrder:
                label = labels[col]
                colControl = label
                headers += f&#34;&#34;&#34;{sep}{colControl}&#34;&#34;&#34;
                sep = TAB

        else:
            headers = []
            dirClass = N.desc if reverse else N.asc
            dirIcon = N.adown if reverse else N.aup
            urlStart = f&#34;&#34;&#34;{PAGE}?country={country}&amp;groups={groups}&amp;&#34;&#34;&#34;
            for col in groupOrder:
                isSorted = col == sortCol
                thisClass = f&#34;c-{col}&#34;
                icon = E
                if isSorted:
                    thisClass += f&#34; {dirClass}&#34;
                    nextReverse = not reverse
                    icon = H.iconx(dirIcon)
                else:
                    nextReverse = False
                reverseRep = -1 if nextReverse else 1
                label = labels[col]
                sep = NBSP if icon else E
                colControl = H.a(
                    f&#34;&#34;&#34;{label}{icon}&#34;&#34;&#34;,
                    f&#34;&#34;&#34;{urlStart}sortcol={col}&amp;reverse={reverseRep}&#34;&#34;&#34;,
                )
                headers.append((colControl, dict(cls=f&#34;och {thisClass}&#34;)))
            headers = (headers, {})

        return headers

    def disclose(self, values, colName, recCountry):
        context = self.context
        auth = context.auth
        isSuperUser = self.isSuperUser
        isCoord = auth.coordinator(countryId=recCountry)

        disclosed = colName != N.cost or isSuperUser or isCoord
        value = values[colName] if disclosed else N.undisclosed
        return value

    @staticmethod
    def wrapStatus(contrib, subHead=False):
        aStage = G(contrib, N.astage)
        assessed = G(contrib, N.assessed) or E
        score = G(contrib, N.score)
        scoreRep = E if score is None else f&#34;&#34;&#34;{score}% - &#34;&#34;&#34;
        baseLabel = assessed if subHead else G(ASSESSED_LABELS, aStage, default=E)
        aClass = (
            G(ASSESSED_CLASS1, assessed, default=ASSESSED_ACCEPTED_CLASS)
            if subHead
            else G(ASSESSED_CLASS, aStage, default=ASSESSED_ACCEPTED_CLASS)
        )
        aLabel = baseLabel if subHead else f&#34;&#34;&#34;{scoreRep}{baseLabel}&#34;&#34;&#34;
        return (aLabel, aClass)

    @staticmethod
    def colRep(col, n):
        itemRep = col if n == 1 else G(COL_PLURAL, col, default=f&#34;&#34;&#34;{col}s&#34;&#34;&#34;)
        return f&#34;&#34;&#34;{n} {itemRep}&#34;&#34;&#34;

    @staticmethod
    def addGroup(groups, g):
        return COMMA.join(groups + [g])

    @staticmethod
    def rmGroup(groups, g):
        return COMMA.join(h for h in groups if h != g)

    @staticmethod
    def expandControls(gid, hide=False):
        hideRep = &#34; hide&#34; if hide else E
        showRep = E if hide else &#34; hide&#34;
        return E.join(
            (
                H.iconx(N.cdown, href=E, cls=f&#34;&#34;&#34;dc{showRep}&#34;&#34;&#34;, gid=gid),
                H.iconx(N.cup, href=E, cls=f&#34;&#34;&#34;dc{hideRep}&#34;&#34;&#34;, gid=gid),
            )
        )

    @staticmethod
    def expandAcontrols(group):
        return E.join(
            (
                H.iconx(N.addown, href=E, cls=f&#34;dca&#34;, gn=group),
                H.iconx(N.adup, href=E, cls=f&#34;dca&#34;, gn=group),
            )
        )

    @staticmethod
    def euro(amount):
        return E if amount is None else f&#34;&#34;&#34;{int(round(amount)):,}&#34;&#34;&#34;

    @staticmethod
    def valTri(tri):
        return E if tri is None else PLUS if tri else MIN

    @staticmethod
    def subHeadClass(col, groupSet, subHead, allHead):
        theClass = (
            &#34;allhead&#34;
            if allHead and col == N.selected
            else &#34;subhead&#34;
            if allHead or (subHead and (col in groupSet or col in SUBHEAD_X_COLS))
            else E
        )
        return f&#34; {theClass}&#34; if theClass else E</code></pre>
</details>
<h3>Static methods</h3>
<dl>
<dt id="control.overview.Overview.addGroup"><code class="name flex">
<span>def <span class="ident">addGroup</span></span>(<span>groups, g)</span>
</code></dt>
<dd>
<section class="desc"></section>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@staticmethod
def addGroup(groups, g):
    return COMMA.join(groups + [g])</code></pre>
</details>
</dd>
<dt id="control.overview.Overview.colRep"><code class="name flex">
<span>def <span class="ident">colRep</span></span>(<span>col, n)</span>
</code></dt>
<dd>
<section class="desc"></section>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@staticmethod
def colRep(col, n):
    itemRep = col if n == 1 else G(COL_PLURAL, col, default=f&#34;&#34;&#34;{col}s&#34;&#34;&#34;)
    return f&#34;&#34;&#34;{n} {itemRep}&#34;&#34;&#34;</code></pre>
</details>
</dd>
<dt id="control.overview.Overview.euro"><code class="name flex">
<span>def <span class="ident">euro</span></span>(<span>amount)</span>
</code></dt>
<dd>
<section class="desc"></section>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@staticmethod
def euro(amount):
    return E if amount is None else f&#34;&#34;&#34;{int(round(amount)):,}&#34;&#34;&#34;</code></pre>
</details>
</dd>
<dt id="control.overview.Overview.expandAcontrols"><code class="name flex">
<span>def <span class="ident">expandAcontrols</span></span>(<span>group)</span>
</code></dt>
<dd>
<section class="desc"></section>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@staticmethod
def expandAcontrols(group):
    return E.join(
        (
            H.iconx(N.addown, href=E, cls=f&#34;dca&#34;, gn=group),
            H.iconx(N.adup, href=E, cls=f&#34;dca&#34;, gn=group),
        )
    )</code></pre>
</details>
</dd>
<dt id="control.overview.Overview.expandControls"><code class="name flex">
<span>def <span class="ident">expandControls</span></span>(<span>gid, hide=False)</span>
</code></dt>
<dd>
<section class="desc"></section>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@staticmethod
def expandControls(gid, hide=False):
    hideRep = &#34; hide&#34; if hide else E
    showRep = E if hide else &#34; hide&#34;
    return E.join(
        (
            H.iconx(N.cdown, href=E, cls=f&#34;&#34;&#34;dc{showRep}&#34;&#34;&#34;, gid=gid),
            H.iconx(N.cup, href=E, cls=f&#34;&#34;&#34;dc{hideRep}&#34;&#34;&#34;, gid=gid),
        )
    )</code></pre>
</details>
</dd>
<dt id="control.overview.Overview.rmGroup"><code class="name flex">
<span>def <span class="ident">rmGroup</span></span>(<span>groups, g)</span>
</code></dt>
<dd>
<section class="desc"></section>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@staticmethod
def rmGroup(groups, g):
    return COMMA.join(h for h in groups if h != g)</code></pre>
</details>
</dd>
<dt id="control.overview.Overview.subHeadClass"><code class="name flex">
<span>def <span class="ident">subHeadClass</span></span>(<span>col, groupSet, subHead, allHead)</span>
</code></dt>
<dd>
<section class="desc"></section>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@staticmethod
def subHeadClass(col, groupSet, subHead, allHead):
    theClass = (
        &#34;allhead&#34;
        if allHead and col == N.selected
        else &#34;subhead&#34;
        if allHead or (subHead and (col in groupSet or col in SUBHEAD_X_COLS))
        else E
    )
    return f&#34; {theClass}&#34; if theClass else E</code></pre>
</details>
</dd>
<dt id="control.overview.Overview.valTri"><code class="name flex">
<span>def <span class="ident">valTri</span></span>(<span>tri)</span>
</code></dt>
<dd>
<section class="desc"></section>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@staticmethod
def valTri(tri):
    return E if tri is None else PLUS if tri else MIN</code></pre>
</details>
</dd>
<dt id="control.overview.Overview.wrapStatus"><code class="name flex">
<span>def <span class="ident">wrapStatus</span></span>(<span>contrib, subHead=False)</span>
</code></dt>
<dd>
<section class="desc"></section>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@staticmethod
def wrapStatus(contrib, subHead=False):
    aStage = G(contrib, N.astage)
    assessed = G(contrib, N.assessed) or E
    score = G(contrib, N.score)
    scoreRep = E if score is None else f&#34;&#34;&#34;{score}% - &#34;&#34;&#34;
    baseLabel = assessed if subHead else G(ASSESSED_LABELS, aStage, default=E)
    aClass = (
        G(ASSESSED_CLASS1, assessed, default=ASSESSED_ACCEPTED_CLASS)
        if subHead
        else G(ASSESSED_CLASS, aStage, default=ASSESSED_ACCEPTED_CLASS)
    )
    aLabel = baseLabel if subHead else f&#34;&#34;&#34;{scoreRep}{baseLabel}&#34;&#34;&#34;
    return (aLabel, aClass)</code></pre>
</details>
</dd>
</dl>
<h3>Methods</h3>
<dl>
<dt id="control.overview.Overview.contribKey"><code class="name flex">
<span>def <span class="ident">contribKey</span></span>(<span>self, col, individual=False)</span>
</code></dt>
<dd>
<section class="desc"></section>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def contribKey(self, col, individual=False):
    types = self.types

    colType = types[col]

    def makeKey(contrib):
        if col == N.assessed:
            return G(contrib, N.arank)
        value = G(contrib, col)
        if value is None:
            return E if colType is str else 0
        if colType is str:
            return value.lower()
        if colType is bool:
            return 1 if value else -1
        return value

    def makeKeyInd(value):
        if col == N.assessed:
            return value
        if value is None:
            return E if colType is str else 0
        if colType is str:
            return value.lower()
        if colType is bool:
            return 1 if value else -1
        return value

    return makeKeyInd if individual else makeKey</code></pre>
</details>
</dd>
<dt id="control.overview.Overview.disclose"><code class="name flex">
<span>def <span class="ident">disclose</span></span>(<span>self, values, colName, recCountry)</span>
</code></dt>
<dd>
<section class="desc"></section>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def disclose(self, values, colName, recCountry):
    context = self.context
    auth = context.auth
    isSuperUser = self.isSuperUser
    isCoord = auth.coordinator(countryId=recCountry)

    disclosed = colName != N.cost or isSuperUser or isCoord
    value = values[colName] if disclosed else N.undisclosed
    return value</code></pre>
</details>
</dd>
<dt id="control.overview.Overview.formatContrib"><code class="name flex">
<span>def <span class="ident">formatContrib</span></span>(<span>self, contrib, groupId, chosenCountry, asTsv, groupOrder=None, groupSet=set(), subHead=False, allHead=False, groupLen=None, depth=None, thisGroupId=None, nGroups=None, hide=False)</span>
</code></dt>
<dd>
<section class="desc"></section>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def formatContrib(
    self,
    contrib,
    groupId,
    chosenCountry,
    asTsv,
    groupOrder=None,
    groupSet=set(),
    subHead=False,
    allHead=False,
    groupLen=None,
    depth=None,
    thisGroupId=None,
    nGroups=None,
    hide=False,
):
    cols = self.cols

    if groupOrder is None:
        groupOrder = cols
    contribId = G(contrib, N._id)
    (assessedLabel, assessedClass) = self.wrapStatus(contrib, subHead=subHead)
    if allHead:
        selected = G(contrib, N.selected) or E
        if asTsv:
            selected = self.valTri(selected)
        assessedClass = E
    else:
        selected = G(contrib, N.selected)
        selected = (
            (self.valTri(selected) if asTsv else self.roTri(selected))
            if N.selected in contrib
            else E
        )
    rawTitle = G(contrib, N.title) or E
    title = (
        rawTitle
        if asTsv
        else rawTitle
        if subHead
        else H.a(
            f&#34;&#34;&#34;{rawTitle or &#34;? missing title ?&#34;}&#34;&#34;&#34;,
            f&#34;&#34;&#34;/{N.contrib}/{N.item}/{contribId}&#34;&#34;&#34;,
        )
        if N.title in contrib
        else E
    )

    values = {
        N.country: G(contrib, N.country) or E,
        N.year: G(contrib, N.year) or E,
        N.type: G(contrib, N.type) or E,
        N.cost: self.euro(G(contrib, N.cost)),
        N.assessed: assessedLabel,
        N.selected: selected,
        N.title: title,
    }
    recCountry = G(contrib, N._cn) or G(values, N.country)
    if depth is not None:
        xGroup = groupOrder[depth] if depth == 0 or depth &lt; groupLen else N.title
        xName = N.contribution if xGroup == N.title else xGroup
        xRep = self.colRep(xName, nGroups)
        values[xGroup] = (
            xRep
            if asTsv
            else (
                f&#34;&#34;&#34;{self.expandControls(thisGroupId, True)} {xRep}&#34;&#34;&#34;
                if xGroup == N.title
                else f&#34;&#34;&#34;{values[xGroup]} ({xRep}) {self.expandControls(thisGroupId)}&#34;&#34;&#34;
                if depth &gt; 0
                else f&#34;&#34;&#34;{values[xGroup]} ({xRep}) {self.expandControls(thisGroupId)}&#34;&#34;&#34;
            )
        )
    if not asTsv:
        classes = {col: f&#34;c-{col}&#34; for col in groupOrder}
        classes[&#34;assessed&#34;] += f&#34; {assessedClass}&#34;
    if asTsv:
        columns = TAB.join(
            self.disclose(values, col, recCountry) or E for col in groupOrder
        )
    else:
        columns = [
            (
                self.disclose(values, col, recCountry),
                dict(
                    cls=(
                        f&#34;{classes[col]} &#34;
                        + self.subHeadClass(col, groupSet, subHead, allHead)
                    )
                ),
            )
            for col in groupOrder
        ]
    if not asTsv:
        hideRep = &#34; hide&#34; if hide else E
        displayAtts = (
            {} if groupId is None else dict(cls=f&#34;dd{hideRep}&#34;, gid=groupId)
        )
    return columns if asTsv else (columns, displayAtts)</code></pre>
</details>
</dd>
<dt id="control.overview.Overview.getContribs"><code class="name flex">
<span>def <span class="ident">getContribs</span></span>(<span>self)</span>
</code></dt>
<dd>
<section class="desc"></section>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def getContribs(self):
    context = self.context
    db = context.db
    chosenCountryId = self.chosenCountryId
    countryType = self.countryType
    yearType = self.yearType
    typeType = self.typeType

    contribs = {}
    for record in db.bulkContribWorkflow(chosenCountryId):
        title = G(record, N.title)
        contribId = G(record, N._id)

        selected = G(record, N.selected)
        aStage = G(record, N.aStage)
        rStage = G(record, N.rStage)
        if rStage in {N.reviewAccept, N.reviewReject}:
            aStage = rStage
        score = G(record, N.score)
        assessed = ASSESSED_STATUS[aStage][0]
        aRank = (G(ASSESSED_RANK, aStage, default=0), score)
        if aStage != N.reviewAccept:
            score = None

        countryRep = countryType.titleStr(G(db.country, G(record, N.country)))
        yearRep = yearType.titleStr(G(db.year, G(record, N.year)))
        typeRep = typeType.titleStr(G(db.typeContribution, G(record, N.type)))
        cost = G(record, N.cost)

        contribs[contribId] = {
            N._id: contribId,
            N._cn: countryRep,
            N.country: countryRep,
            N.year: yearRep,
            N.type: typeRep,
            N.title: title,
            N.cost: cost,
            N.assessed: assessed,
            N.arank: aRank,
            N.astage: aStage,
            N.score: score,
            N.selected: selected,
        }

    self.contribs = contribs</code></pre>
</details>
</dd>
<dt id="control.overview.Overview.getCountry"><code class="name flex">
<span>def <span class="ident">getCountry</span></span>(<span>self, country)</span>
</code></dt>
<dd>
<section class="desc"></section>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def getCountry(self, country):
    context = self.context
    db = context.db
    auth = context.auth
    user = auth.user
    countryType = self.countryType

    self.userGroup = auth.groupRep()
    self.myCountry = auth.countryRep()

    userCountryId = G(user, N.country)
    chosenCountry = None
    chosenCountryIso = None
    chosenCountryId = None

    countryId = G(db.countryInv, country) if country else userCountryId

    if countryId is not None:
        chosenCountryId = countryId
        countryInfo = G(db.country, chosenCountryId, default={})
        chosenCountry = countryType.titleStr(countryInfo)
        chosenCountryIso = G(countryInfo, N.iso)

    self.chosenCountry = chosenCountry
    self.chosenCountryId = chosenCountryId
    self.chosenCountryIso = chosenCountryIso</code></pre>
</details>
</dd>
<dt id="control.overview.Overview.groupList"><code class="name flex">
<span>def <span class="ident">groupList</span></span>(<span>self, groups, selectedCountry, chosenCountry, asTsv)</span>
</code></dt>
<dd>
<section class="desc"></section>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def groupList(
    self, groups, selectedCountry, chosenCountry, asTsv,
):
    cols = self.cols
    groupCols = self.groupCols
    contribs = self.contribs
    sortCol = self.sortCol
    reverse = self.reverse

    if len(groups) == 0:
        groupedList = sorted(
            contribs.values(), key=self.contribKey(sortCol), reverse=reverse
        )
        if asTsv:
            return (
                NL.join(
                    self.formatContrib(contrib, None, chosenCountry, asTsv,)
                    for contrib in groupedList
                ),
                E,
            )
        else:
            return (
                [
                    self.formatContrib(contrib, None, chosenCountry, asTsv,)
                    for contrib in groupedList
                ],
                E,
            )

    preGroups = groups[0:-1]
    lastGroup = groups[-1]

    groupLen = len(groups)
    groupSet = set(groups)
    groupOrder = groups + [g for g in cols if g not in groupSet]

    groupedList = {}

    for c in contribs.values():
        dest = groupedList
        for g in preGroups:
            dest = dest.setdefault(G(c, g), {})
        dest = dest.setdefault(G(c, lastGroup), [])
        dest.append(c)

    material = []
    maxGroupId = 1
    groupRel = {}

    def groupMaterial(gList, depth, groupValues, parentGroupId):
        groupSet = set(groupValues.keys())

        nonlocal maxGroupId
        maxGroupId += 1
        thisGroupId = maxGroupId
        thisGroupId = COMMA.join(f&#34;&#34;&#34;{k}:{v}&#34;&#34;&#34; for (k, v) in groupValues.items())
        groupRel.setdefault(str(parentGroupId), []).append(str(thisGroupId))

        headIndex = len(material)
        material.append(MIN if asTsv else ([(MIN, {})], {}))
        nRecords = 0
        nGroups = 0
        cost = 0
        if type(gList) is list:
            for rec in sorted(
                (
                    {k: v for (k, v) in list(d.items()) if k not in groupValues}
                    for d in gList
                ),
                key=self.contribKey(sortCol),
                reverse=reverse,
            ):
                nRecords += 1
                nGroups += 1
                cost += G(rec, N.cost) or 0
                material.append(
                    self.formatContrib(
                        rec,
                        thisGroupId,
                        chosenCountry,
                        asTsv,
                        groupOrder=groupOrder,
                        hide=True,
                    )
                )
        else:
            newGroup = groups[depth]
            for groupValue in sorted(
                gList.keys(),
                key=self.contribKey(newGroup, individual=True),
                reverse=reverse,
            ):
                nGroups += 1
                newGroupValues = {}
                newGroupValues.update(groupValues)
                newGroupValues[newGroup] = groupValue
                (nRecordsG, costG) = groupMaterial(
                    gList[groupValue], depth + 1, newGroupValues, thisGroupId,
                )
                nRecords += nRecordsG
                cost += costG
        groupValuesT = {}
        if depth &gt; 0:
            thisGroup = groups[depth - 1]
            groupValuesT[thisGroup] = groupValues[thisGroup]
        # groupValuesT.update(groupValues)
        groupValuesT[N.cost] = cost
        groupValuesT[N.title] = self.colRep(N.contribution, nRecords)
        groupValuesT[N._cn] = G(groupValues, N.country)
        if depth == 0:
            for g in groupCols + [N.title]:
                label = selectedCountry if g == N.country else N.all
                controls = (
                    self.expandAcontrols(g) if g in groups or g == N.title else E
                )
                groupValuesT[g] = label if asTsv else f&#34;&#34;&#34;{label} {controls}&#34;&#34;&#34;
        material[headIndex] = self.formatContrib(
            groupValuesT,
            parentGroupId,
            chosenCountry,
            asTsv,
            groupOrder=groupOrder,
            groupSet=groupSet,
            subHead=True,
            allHead=depth == 0,
            groupLen=groupLen,
            depth=depth,
            thisGroupId=thisGroupId,
            nGroups=nGroups,
        )
        return (nRecords, cost)

    groupMaterial(groupedList, 0, {}, 1)
    return (
        NL.join(material) if asTsv else material,
        H.script(f&#34;&#34;&#34;var groupRel = {json.dumps(groupRel)}&#34;&#34;&#34;),
    )</code></pre>
</details>
</dd>
<dt id="control.overview.Overview.ourCountryHeaders"><code class="name flex">
<span>def <span class="ident">ourCountryHeaders</span></span>(<span>self, country, groups, asTsv, groupOrder=None)</span>
</code></dt>
<dd>
<section class="desc"></section>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def ourCountryHeaders(self, country, groups, asTsv, groupOrder=None):
    cols = self.cols
    labels = self.labels
    sortCol = self.sortCol
    reverse = self.reverse

    if groupOrder is None:
        groupOrder = cols

    if asTsv:
        headers = E
        sep = E
        for col in groupOrder:
            label = labels[col]
            colControl = label
            headers += f&#34;&#34;&#34;{sep}{colControl}&#34;&#34;&#34;
            sep = TAB

    else:
        headers = []
        dirClass = N.desc if reverse else N.asc
        dirIcon = N.adown if reverse else N.aup
        urlStart = f&#34;&#34;&#34;{PAGE}?country={country}&amp;groups={groups}&amp;&#34;&#34;&#34;
        for col in groupOrder:
            isSorted = col == sortCol
            thisClass = f&#34;c-{col}&#34;
            icon = E
            if isSorted:
                thisClass += f&#34; {dirClass}&#34;
                nextReverse = not reverse
                icon = H.iconx(dirIcon)
            else:
                nextReverse = False
            reverseRep = -1 if nextReverse else 1
            label = labels[col]
            sep = NBSP if icon else E
            colControl = H.a(
                f&#34;&#34;&#34;{label}{icon}&#34;&#34;&#34;,
                f&#34;&#34;&#34;{urlStart}sortcol={col}&amp;reverse={reverseRep}&#34;&#34;&#34;,
            )
            headers.append((colControl, dict(cls=f&#34;och {thisClass}&#34;)))
        headers = (headers, {})

    return headers</code></pre>
</details>
</dd>
<dt id="control.overview.Overview.roTri"><code class="name flex">
<span>def <span class="ident">roTri</span></span>(<span>self, tri)</span>
</code></dt>
<dd>
<section class="desc"></section>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def roTri(self, tri):
    return self.bool3Obj.toDisplay(tri, markup=False)</code></pre>
</details>
</dd>
<dt id="control.overview.Overview.wrap"><code class="name flex">
<span>def <span class="ident">wrap</span></span>(<span>self, asTsv=False)</span>
</code></dt>
<dd>
<section class="desc"></section>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def wrap(self, asTsv=False):
    context = self.context
    db = context.db
    auth = context.auth
    countryType = self.countryType

    self.isSuperUser = auth.superuser()
    self.isCoord = auth.coordinator()

    colSpecs = COLSPECS
    groupCols = GROUP_COLS
    allGroupSet = set(groupCols)

    accessRep = auth.credentials()[1]

    rawSortCol = request.args.get(N.sortcol, E)
    rawReverse = request.args.get(N.reverse, E)
    country = request.args.get(N.country, E)
    groups = COMMA.join(
        g for g in request.args.get(N.groups, E).split(COMMA) if g in allGroupSet
    )

    self.getCountry(country)
    self.getContribs()

    chosenCountry = self.chosenCountry
    chosenCountryId = self.chosenCountryId
    chosenCountryIso = self.chosenCountryIso

    if chosenCountryId is not None:
        colSpecs = COLSPECS[1:]
        groups = self.rmGroup(groups.split(COMMA), N.country)
        groupCols = GROUP_COLS[1:]

    cols = [c[0] for c in colSpecs]
    colSet = {c[0] for c in colSpecs}

    self.types = dict((c[0], c[1]) for c in colSpecs)
    labels = dict((c[0], c[2] if len(c) &gt; 2 else c[0]) for c in colSpecs)
    sortDefault = cols[-1]

    groupsChosen = [] if not groups else groups.split(COMMA)
    groupSet = set(groupsChosen)
    groupStr = (&#34;&#34;&#34;-by-&#34;&#34;&#34; if groupSet else E) + MIN.join(sorted(groupSet))

    sortCol = sortDefault if rawSortCol not in colSet else rawSortCol
    reverse = False if rawReverse not in {MINONE, ONE} else rawReverse == MINONE

    self.cols = cols
    self.labels = labels
    self.groupCols = groupCols
    self.sortCol = sortCol
    self.reverse = reverse

    material = []
    if not asTsv:
        material.append(H.h(3, &#34;&#34;&#34;Country selection&#34;&#34;&#34;))

        countryItems = [
            H.a(
                ALL,
                (
                    f&#34;&#34;&#34;{PAGE}?country=x&amp;sortcol={rawSortCol}&amp;&#34;&#34;&#34;
                    f&#34;&#34;&#34;reverse={rawReverse}&amp;groups={groups}&#34;&#34;&#34;
                ),
                cls=&#34;c-control&#34;,
            )
            if chosenCountryId
            else H.span(ALL, cls=&#34;c-focus&#34;)
        ]
        for (cid, countryInfo) in db.country.items():
            if not G(countryInfo, N.isMember):
                continue
            name = countryType.titleStr(countryInfo)
            iso = G(countryInfo, N.iso)

            countryItems.append(
                H.span(name, cls=&#34;c-focus&#34;)
                if cid == chosenCountryId
                else H.a(
                    name,
                    (
                        f&#34;&#34;&#34;{PAGE}?country={iso}&amp;sortcol={rawSortCol}&amp;&#34;&#34;&#34;
                        f&#34;&#34;&#34;reverse={rawReverse}&amp;groups={groups}&#34;&#34;&#34;
                    ),
                    cls=&#34;c-control&#34;,
                )
            )
        material.append(H.p(countryItems, cls=N.countries))

    groupsAvailable = sorted(allGroupSet - set(groupsChosen))
    groupOrder = groupsChosen + [g for g in cols if g not in groupSet]

    if not asTsv:
        urlArgs = (
            f&#34;&#34;&#34;?country={chosenCountryIso}&amp;&#34;&#34;&#34;
            f&#34;&#34;&#34;sortcol={rawSortCol}&amp;reverse={rawReverse}&amp;&#34;&#34;&#34;
        )
        urlStart1 = f&#34;&#34;&#34;{PAGE}{urlArgs}&#34;&#34;&#34;
        urlStart = f&#34;&#34;&#34;{urlStart1}&#34;&#34;&#34; f&#34;&amp;groups=&#34;
        availableReps = E.join(
            H.a(
                f&#34;&#34;&#34;+{g}&#34;&#34;&#34;,
                (f&#34;&#34;&#34;{urlStart}{self.addGroup(groupsChosen, g)}&#34;&#34;&#34;),
                cls=&#34;g-add&#34;,
            )
            for g in groupsAvailable
        )
        chosenReps = E.join(
            H.a(
                f&#34;&#34;&#34;-{g}&#34;&#34;&#34;,
                f&#34;&#34;&#34;{urlStart}{self.rmGroup(groupsChosen, g)}&#34;&#34;&#34;,
                cls=&#34;g-rm&#34;,
            )
            for g in groupsChosen
        )
        clearGroups = (
            E
            if len(chosenReps) == 0
            else H.iconx(
                N.clear, urlStart1, cls=&#34;g-x&#34;, title=&#34;&#34;&#34;clear all groups&#34;&#34;&#34;
            )
        )
        rArgs = f&#34;&#34;&#34;{urlArgs}groups={groups}&#34;&#34;&#34;

    headerLine = self.ourCountryHeaders(
        country, groups, asTsv, groupOrder=groupOrder,
    )

    contribs = self.contribs
    nContribs = len(contribs)
    plural = E if nContribs == 1 else S
    things = f&#34;&#34;&#34;{len(contribs)} contribution{plural}&#34;&#34;&#34;
    origin = chosenCountry or ALL.lower()

    if not asTsv:
        material.append(H.h(3, &#34;&#34;&#34;Grouping&#34;&#34;&#34;))
        material.append(
            H.table(
                [],
                [
                    (
                        [
                            (&#34;&#34;&#34;available groups&#34;&#34;&#34;, dict(cls=&#34;mtl&#34;)),
                            (availableReps, dict(cls=&#34;mtd&#34;)),
                            (NBSP, {}),
                        ],
                        {},
                    ),
                    (
                        [
                            (&#34;&#34;&#34;chosen groups&#34;&#34;&#34;, dict(cls=&#34;mtl&#34;)),
                            (chosenReps, dict(cls=&#34;mtd&#34;)),
                            (clearGroups, {}),
                        ],
                        {},
                    ),
                ],
                cls=&#34;mt&#34;,
            )
        )
        material.append(
            H.h(
                3,
                [
                    f&#34;&#34;&#34;{things} from {origin}&#34;&#34;&#34;,
                    H.a(
                        &#34;&#34;&#34;Download as Excel&#34;&#34;&#34;,
                        f&#34;&#34;&#34;{PAGEX}{rArgs}&#34;&#34;&#34;,
                        target=&#34;_blank&#34;,
                        cls=&#34;button large&#34;,
                    ),
                ],
            )
        )

    (thisMaterial, groupRel) = self.groupList(
        groupsChosen, chosenCountry, chosenCountry, asTsv,
    )

    if asTsv:
        material.append(thisMaterial)
    else:
        material.append(H.table([headerLine], thisMaterial, cls=&#34;cc&#34;))
        material.append(groupRel)

    if asTsv:
        fileName = (
            f&#34;&#34;&#34;dariah-{country or &#34;all-countries&#34;}{groupStr}-for-{accessRep}&#34;&#34;&#34;
        )
        headers = {
            &#34;Expires&#34;: &#34;0&#34;,
            &#34;Cache-Control&#34;: &#34;no-cache, no-store, must-revalidate&#34;,
            &#34;Content-Type&#34;: &#34;text/csv&#34;,
            &#34;Content-Disposition&#34;: f&#39;attachment; filename=&#34;{fileName}&#34;&#39;,
            &#34;Content-Encoding&#34;: &#34;identity&#34;,
        }
        tsv = f&#34;&#34;&#34;\ufeff{headerLine}\n{NL.join(material)}&#34;&#34;&#34;.encode(&#34;&#34;&#34;utf_16_le&#34;&#34;&#34;)
        data = make_response(tsv, headers)
    else:
        data = E.join(material)

    return data</code></pre>
</details>
</dd>
</dl>
</dd>
</dl>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="control" href="index.html">control</a></code></li>
</ul>
</li>
<li><h3><a href="#header-classes">Classes</a></h3>
<ul>
<li>
<h4><code><a title="control.overview.Overview" href="#control.overview.Overview">Overview</a></code></h4>
<ul class="two-column">
<li><code><a title="control.overview.Overview.addGroup" href="#control.overview.Overview.addGroup">addGroup</a></code></li>
<li><code><a title="control.overview.Overview.colRep" href="#control.overview.Overview.colRep">colRep</a></code></li>
<li><code><a title="control.overview.Overview.contribKey" href="#control.overview.Overview.contribKey">contribKey</a></code></li>
<li><code><a title="control.overview.Overview.disclose" href="#control.overview.Overview.disclose">disclose</a></code></li>
<li><code><a title="control.overview.Overview.euro" href="#control.overview.Overview.euro">euro</a></code></li>
<li><code><a title="control.overview.Overview.expandAcontrols" href="#control.overview.Overview.expandAcontrols">expandAcontrols</a></code></li>
<li><code><a title="control.overview.Overview.expandControls" href="#control.overview.Overview.expandControls">expandControls</a></code></li>
<li><code><a title="control.overview.Overview.formatContrib" href="#control.overview.Overview.formatContrib">formatContrib</a></code></li>
<li><code><a title="control.overview.Overview.getContribs" href="#control.overview.Overview.getContribs">getContribs</a></code></li>
<li><code><a title="control.overview.Overview.getCountry" href="#control.overview.Overview.getCountry">getCountry</a></code></li>
<li><code><a title="control.overview.Overview.groupList" href="#control.overview.Overview.groupList">groupList</a></code></li>
<li><code><a title="control.overview.Overview.ourCountryHeaders" href="#control.overview.Overview.ourCountryHeaders">ourCountryHeaders</a></code></li>
<li><code><a title="control.overview.Overview.rmGroup" href="#control.overview.Overview.rmGroup">rmGroup</a></code></li>
<li><code><a title="control.overview.Overview.roTri" href="#control.overview.Overview.roTri">roTri</a></code></li>
<li><code><a title="control.overview.Overview.subHeadClass" href="#control.overview.Overview.subHeadClass">subHeadClass</a></code></li>
<li><code><a title="control.overview.Overview.valTri" href="#control.overview.Overview.valTri">valTri</a></code></li>
<li><code><a title="control.overview.Overview.wrap" href="#control.overview.Overview.wrap">wrap</a></code></li>
<li><code><a title="control.overview.Overview.wrapStatus" href="#control.overview.Overview.wrapStatus">wrapStatus</a></code></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc"><cite>pdoc</cite> 0.7.5</a>.</p>
</footer>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad()</script>
</body>
</html>