<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.7.2" />
<title>helpers API documentation</title>
<meta name="description" content="Helpers to factor our massively redundant test code." />
<link href='https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.0/normalize.min.css' rel='stylesheet'>
<link href='https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/8.0.0/sanitize.min.css' rel='stylesheet'>
<link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" rel="stylesheet">
<style>.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{font-weight:bold}#index h4 + ul{margin-bottom:.6em}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>helpers</code></h1>
</header>
<section id="section-intro">
<p>Helpers to factor our massively redundant test code.</p>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">&#34;&#34;&#34;Helpers to factor our massively redundant test code.
&#34;&#34;&#34;

import re

from flask import json
from pymongo import MongoClient
from bson.objectid import ObjectId
from control.utils import pick as G, serverprint
from conftest import USER_LIST
from example import (
    _ID,
    CRITERIA,
    CRITERIA_ENTRY,
    EXPERT,
    FINAL,
    LEVEL,
    REVIEW,
    REVIEW_ENTRY,
    SCORE,
    UNDEF_VALUE,
)


materialRe = re.compile(
    r&#34;&#34;&#34;&lt;div id=[&#39;&#34;]material[&#39;&#34;]&gt;(.*?)&lt;/div&gt;\s*&lt;/div&gt;\s*&lt;script&#34;&#34;&#34;, re.S
)
fieldRe = re.compile(&#34;&#34;&#34;&lt;!-- ([a-zA-Z0-9]+)=(.*?) --&gt;&#34;&#34;&#34;, re.S)
mainNRe = re.compile(&#34;&#34;&#34;&lt;!-- mainN~([0-9]+)~(.*?) --&gt;&#34;&#34;&#34;, re.S)
stageRe = re.compile(&#34;&#34;&#34;&lt;!-- stage:(.*?) --&gt;&#34;&#34;&#34;, re.S)
taskRe = re.compile(&#34;&#34;&#34;&lt;!-- task!([a-zA-Z0-9]+):([a-f0-9]+) --&gt;&#34;&#34;&#34;, re.S)
captionRe = re.compile(
    r&#34;&#34;&#34;&lt;!-- caption\^([^&gt;]*?) --&gt;&lt;a [^&gt;]*href=[&#39;&#34;]([^&#39;&#34;]*)[&#39;&#34;]&#34;&#34;&#34;, re.S
)
msgRe = re.compile(&#34;&#34;&#34;&lt;div class=&#34;msgitem.*?&gt;(.*?)&lt;/div&gt;&#34;&#34;&#34;, re.S)
eidRe = re.compile(&#34;&#34;&#34;&lt;details itemkey=[&#39;&#34;][a-zA-Z0-9_]+/([^/&#39;&#34;]*)[&#39;&#34;]&#34;&#34;&#34;, re.S)
userRe = re.compile(
    &#34;&#34;&#34;&lt;details itemkey=[&#39;&#34;]user/([^&#39;&#34;]*)[&#39;&#34;].*?&lt;summary&gt;.*?&lt;span.*?&gt;([^&lt;]*)&lt;/span&gt;&#34;&#34;&#34;,
    re.S,
)
valueRe = re.compile(&#34;&#34;&#34;eid=[&#39;&#34;](.*?)[&#39;&#34;][^&gt;]*&gt;(.*?)(?:&amp;#xa;)?&lt;&#34;&#34;&#34;, re.S)
reviewRe = re.compile(
    &#34;&#34;&#34;&lt;!-- begin reviewer ([A-Za-z0-9]+) --&gt;&#34;&#34;&#34;
    &#34;&#34;&#34;(.*?)&#34;&#34;&#34;
    r&#34;&#34;&#34;&lt;!-- end reviewer \1 --&gt;&#34;&#34;&#34;,
    re.S,
)
reviewEntryIdRe = re.compile(
    f&#34;&#34;&#34;&lt;span [^&gt;]*?table=[&#39;&#34;]{REVIEW_ENTRY}[&#39;&#34;][^&gt;]*&gt;&#34;&#34;&#34;, re.S
)
idRe = re.compile(&#34;&#34;&#34;eid=[&#39;&#34;]([^&#39;&#34;]*)[&#39;&#34;]&#34;&#34;&#34;, re.S)


def accessUrl(client, url, redirect=False):
    &#34;&#34;&#34;Get the response on accessing a url.&#34;&#34;&#34;

    response = client.get(url, follow_redirects=redirect)
    text = response.get_data(as_text=True)
    status = response.status_code
    msgs = findMsg(text)
    return (text, status, msgs)


def checkWarning(text, label):
    &#34;&#34;&#34;Whether there is a warned item with `label`.

    See `reWarning`.
    &#34;&#34;&#34;

    return not not reWarning(label).search(text)


def checkCreator(table, eid, user):
    &#34;&#34;&#34;Checks whether a user is the creator of a record.

    Parameters
    ----------
    table: string

    Returns
    -------
    &#34;&#34;&#34;
    client = MongoClient()
    mongo = client.dariah_test
    userId = G(list(mongo.user.find(dict(eppn=user)))[0], _ID)
    records = list(mongo[table].find(dict(_id=ObjectId(eid), creator=userId)))
    return len(records) &gt; 0


def findCaptions(text):
    &#34;&#34;&#34;Get the captions from a response.

    !!! hint
        They are neatly packaged in comment lines!

    Parameters
    ----------
    text: string
        The response text.

    Returns
    -------
    list of string
    &#34;&#34;&#34;

    return captionRe.findall(text)


def findDetails(text, dtable):
    &#34;&#34;&#34;Get the details from a response, but only those in a specific table.

    Parameters
    ----------
    text: string
        The response text.
    dtail: string
        The detail table

    Returns
    -------
    list of tuple of (string(id), string(html))
        The HTML for the details, chunked per detail record.
        Each chunk consists of the following parts:

        *   the entity id of that detail,
        *   the piece of HTML representing the title of the detail.
    &#34;&#34;&#34;

    result = []
    for (eid, mat) in reDetail(dtable).findall(text):
        result.append((eid, mat))
    return result


def findEid(text, multiple=False):
    &#34;&#34;&#34;Get the entity id(s) from a response.

    If the response shows a record, dig out its entity id.

    Otherwise, return `None`

    Parameters
    ----------
    text: string
        The response text.
    multiple: boolean
        Whether we should return the list of all found ids or only the first one.

    Returns
    -------
    list of string(ObjectId) | string(ObjectId) | `None`
    &#34;&#34;&#34;

    results = eidRe.findall(text)
    return results if multiple else results[0] if results else None


def findFields(text):
    &#34;&#34;&#34;Get the fields from a response.

    If the response shows a record, dig out its fields and values.

    !!! hint
        They are neatly packaged in comment lines!

    Parameters
    ----------
    text: string
        The response text.

    Returns
    -------
    dict
        Keyed by field names, valued by field values.
    &#34;&#34;&#34;

    return {field: value for (field, value) in fieldRe.findall(text)}


def findMainN(text):
    &#34;&#34;&#34;Get the number of main records from a response.

    !!! hint
        They are neatly packaged in comment lines!

    Parameters
    ----------
    text: string
        The response text.

    Returns
    -------
    list of string
    &#34;&#34;&#34;

    return mainNRe.findall(text)


def findMsg(text):
    &#34;&#34;&#34;Get flashed messages from a response.

    Parameters
    ----------
    text: string
        The response text.

    Returns
    -------
    set
        All text messages found in the flash bar.
    &#34;&#34;&#34;

    return set(msgRe.findall(text))


def findReviewEntries(text):
    &#34;&#34;&#34;Get review entries from a criteria entry record.

    Parameters
    ----------
    text: string
        The response text of a request for an item view on a criteriaEntry record.

    Returns
    -------
    dict
        Keyed by `expert` or `final`. The values are the review comments of that
        reviewer on this criteria entry.
    &#34;&#34;&#34;

    result = {}
    for (kind, material) in reviewRe.findall(text):
        spans = reviewEntryIdRe.findall(material)
        if spans:
            reIds = idRe.findall(spans[0])
            if reIds:
                reId = reIds[0]
                fields = findFields(material)
                result[kind] = (reId, fields)
    return result


def findStages(text):
    &#34;&#34;&#34;Get the workflow stages from a response.

    !!! hint
        They are neatly packaged in comment lines!

    Parameters
    ----------
    text: string
        The response text.

    Returns
    -------
    list of string
    &#34;&#34;&#34;

    return stageRe.findall(text)


def findTasks(text):
    &#34;&#34;&#34;Get the workflow tasks from a response.

    !!! hint
        They are neatly packaged in comment lines!

    Parameters
    ----------
    text: string
        The response text.

    Returns
    -------
    list of string
    &#34;&#34;&#34;

    return taskRe.findall(text)


def findValues(table, text):
    &#34;&#34;&#34;Get the values from the response of a list view on that table.

    Parameters
    ----------
    table: string
    text: string
        The response text.

    Returns
    -------
    dict
        keyed by the titles of the records and valued by their ids.
    &#34;&#34;&#34;

    return {name: eid for (eid, name) in reValueList(table).findall(text)}


def forall(cls, expect, assertFunc, *args):
    &#34;&#34;&#34;Executes an assert function for a subset of all clients.

    The subset is determined by `expect`, which holds expected outcomes
    for the clients.

    Parameters
    ----------
    cls: fixture
        Contains a dict of all clients: `conftest.clients`
    assertFunc: function
        The function to be applied for each client.
        It will be passed all the `args` and a relevant part of `expect`
    expect: dict
        Keyed by user (eppn), contains the expected value for that user.
    &#34;&#34;&#34;

    for user in USER_LIST:
        if user not in expect:
            continue
        exp = expect[user]
        serverprint(f&#34;USER {user} EXPECTS {exp}&#34;)
        assertFunc(cls[user], *args, exp)


def getEid(client, table, multiple=False):
    &#34;&#34;&#34;Gets the id(s) of the records(s) in the mylist view.

    !!! caution
        Not all tables have a `mylist` view. Only contributions, assessments
        and reviews.

    Parameters
    ----------
    table: string
    &#34;&#34;&#34;

    url = f&#34;/{table}/list?action=my&#34;
    (text, status, msgs) = accessUrl(client, url, redirect=True)
    return findEid(text, multiple=multiple)


def getItem(client, table, eid):
    &#34;&#34;&#34;Looks up an item directly.

    The response texts will be analysed into messages and fields, the eid
    of the item will be read off.

    We assume that there is still only one item in the view.

    Parameters
    ----------
    client: fixture
    table: string
    action: string, optional `None`
        The view on the table, such as `my`, `our`.

    Returns
    -------
    text: string
        The complete response text
    fields: dict
        All fields and their values
    msgs: list
        All entries that have been flashed (and arrived in the flash bar)
    eid: str(ObjectId)
        The id of the item.
    &#34;&#34;&#34;

    url = f&#34;/{table}/item/{eid}&#34;
    response = client.get(url)
    text = response.get_data(as_text=True)
    fields = {field: value for (field, value) in fieldRe.findall(text)}
    msgs = findMsg(text)
    eid = findEid(text)
    return (text, fields, msgs, eid)


def getItemEids(client, table, action=None):
    &#34;&#34;&#34;Looks up item eids from a view on a table.

    The response texts will be analysed into messages and fields, the eids
    of the items will be read off.

    Parameters
    ----------
    client: fixture
    table: string
    action: string, optional `None`
        The view on the table, such as `my`, `our`.

    Returns
    -------
    eid: list of str(ObjectId)
        The ids of the item that can be found.
    &#34;&#34;&#34;

    actionStr = &#34;&#34; if action is None else f&#34;?action={action}&#34;
    response = client.get(f&#34;/{table}/list{actionStr}&#34;)
    text = response.get_data(as_text=True)
    return findEid(text, multiple=True)


def getREIds(clients, cId, direct=None):
    &#34;&#34;&#34;Get the review entries associated with a criteria entry.

    Parameters
    ----------
    clients: dict
        Keyed by user eppns, values by the corresponding client fixtures
    cId: string(ObjectId)
        The id of the criteria entry in question
    direct: tuple of ObjectId, optional, `None`
        If `None`, the review entries ids are peeled from a response text.
        If present, it is a pair of review ids, the first of an expert review,
        the second of a final review. These ids are used in a MongoDB query to get
        the corresponding review entries.

    Returns
    -------
    dict
        Keyed by reviewer (`expert` or `final`), the values are the ids of the
        corresponding review entries.
    &#34;&#34;&#34;

    reId = {}
    if direct:
        client = MongoClient()
        mongo = client.dariah_test
        (rEId, rFId) = direct
        reId = {u: G(
            list(
                mongo[REVIEW_ENTRY].find(
                    {REVIEW: ObjectId(reid), CRITERIA_ENTRY: ObjectId(cId)}
                )
            )[0],
            _ID,
        ) for (u, reid) in zip((EXPERT, FINAL), direct)}
    else:
        for user in {EXPERT, FINAL}:
            (text, fields, msgs, dummy) = getItem(clients[user], CRITERIA_ENTRY, cId)
            reviewEntries = findReviewEntries(text)
            reId[user] = reviewEntries[user][0]
    return reId


def getRelatedValues(client, table, eid, field):
    &#34;&#34;&#34;Get an editable view on a field that represents a related value.&#34;&#34;

    We check the contents.
    &#34;&#34;&#34;
    url = f&#34;/api/{table}/item/{eid}/field/{field}?action=edit&#34;
    response = client.get(url)
    text = response.get_data(as_text=True)
    thisRe = reEditField(eid, field)
    valueStr = thisRe.findall(text)
    values = valueRe.findall(valueStr[0])
    valueDict = {value: eid for (eid, value) in values}
    return valueDict


def getScores(cId):
    &#34;&#34;&#34;Get relevant scores directly from Mongo DB.

    Parameters
    ----------
    cId: string(ObjectId)
        The id of a criteria entry record whose set of possible scores we
        want to retrieve.

    Returns
    -------
    dict
        Keyed by the title of the score, values are their ids.
    &#34;&#34;&#34;
    client = MongoClient()
    mongo = client.dariah_test
    crId = G(list(mongo.criteriaEntry.find(dict(_id=ObjectId(cId))))[0], CRITERIA)
    scores = mongo.score.find(dict(criteria=ObjectId(crId)))
    result = {}
    for record in scores:
        score = G(record, SCORE)
        if score is None:
            return UNDEF_VALUE
        level = G(record, LEVEL) or UNDEF_VALUE
        title = f&#34;&#34;&#34;{score} - {level}&#34;&#34;&#34;
        result[title] = str(G(record, _ID))
    return result


def modifyField(client, table, eid, field, newValue):
    &#34;&#34;&#34;Post data to update a field and analyse the response for the effect.&#34;&#34;&#34;

    url = f&#34;/api/{table}/item/{eid}/field/{field}?action=view&#34;
    text = postJson(client, url, newValue)
    fields = findFields(text)
    return (text, fields)


def postJson(client, url, value):
    &#34;&#34;&#34;Post data to a url and retrieve the response text.

    Parameters
    ----------
    client: function
    url: string(url)
    value: mixed
        The value to post.
        Will be wrapped into JSON with a proper header.

    Returns
    -------
    string
        The response text
    &#34;&#34;&#34;

    response = client.post(
        url, data=json.dumps(dict(save=value)), content_type=&#34;application/json&#34;,
    )
    text = response.get_data(as_text=True)

    return text


def reDetail(dtable):
    &#34;&#34;&#34;Given a detail table name, return a `re` that looks for the detail records.

    Parameters
    ----------
    dtable: string
    &#34;&#34;&#34;

    return re.compile(
        r&#34;&#34;&#34;&lt;details itemkey=[&#39;&#34;]{dtable}/([^&#39;&#34;]+)[&#39;&#34;][^&gt;]*&gt;(.*?)&lt;/details&gt;&#34;&#34;&#34;.format(
            dtable=dtable
        ),
        re.S,
    )


def reEditField(eid, field):
    &#34;&#34;&#34;Given a field name, return a `re` that looks for the value of that field.

    Parameters
    ----------
    eid: string(ObjectId)
        The id of the record whose field data we are searching
    field: string
    &#34;&#34;&#34;

    return re.compile(
        r&#34;&#34;&#34;
    &lt;span\ [^&gt;]*?eid=[&#39;&#34;]{eid}[&#39;&#34;]\s+field=[&#39;&#34;]{field}[&#39;&#34;].*?
    &lt;div\ wtype=[&#39;&#34;]related[&#39;&#34;]\ .*?
    &lt;div\ class=[&#39;&#34;]wvalue[&#39;&#34;]&gt;(.*?)&lt;/div&gt;
    &#34;&#34;&#34;.format(
            eid=eid, field=field
        ),
        re.S | re.X,
    )


def reValueList(table):
    &#34;&#34;&#34;Given a table name, return a `re` that finds pairs of id and title strings.

    The text is a list display of value records, and we peel the ids from the
    `&lt;detail&gt;` elements and the titles from the `&lt;summary&gt;` within them.

    Parameters
    ----------
    table: string
    &#34;&#34;&#34;

    return re.compile(
        f&#34;&#34;&#34;&lt;details itemkey=[&#39;&#34;]{table}/([^&#39;&#34;]*)[&#39;&#34;].*?&lt;summary&gt;.*?&lt;span.*?&gt;([^&lt;]*)&lt;/span&gt;&#34;&#34;&#34;,
        re.S,
    )


def reWarning(label):
    &#34;&#34;&#34;Given a label, return a `re` that looks for warned items with that label.

    A warned item is an item with a CSS class `warning` in it.

    Parameters
    ----------
    label: string
        Usually the title of an item
    &#34;&#34;&#34;

    return re.compile(
        r&#34;&#34;&#34;\bclass=[&#39;&#34;][^&#39;&#34;]*\bwarning\b[^&#39;&#34;]*[&#39;&#34;][^&gt;]*&gt;{label}&lt;&#34;&#34;&#34;.format(
            label=label
        ),
        re.S,
    )


def viewField(client, table, eid, field):
    &#34;&#34;&#34;Get the response for showing a field.&#34;&#34;&#34;

    url = f&#34;/api/{table}/item/{eid}/field/{field}?action=view&#34;
    response = client.get(url)
    text = response.get_data(as_text=True)
    fields = findFields(text)
    return (text, fields)</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-functions">Functions</h2>
<dl>
<dt id="helpers.accessUrl"><code class="name flex">
<span>def <span class="ident">accessUrl</span></span>(<span>client, url, redirect=False)</span>
</code></dt>
<dd>
<section class="desc"><p>Get the response on accessing a url.</p></section>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def accessUrl(client, url, redirect=False):
    &#34;&#34;&#34;Get the response on accessing a url.&#34;&#34;&#34;

    response = client.get(url, follow_redirects=redirect)
    text = response.get_data(as_text=True)
    status = response.status_code
    msgs = findMsg(text)
    return (text, status, msgs)</code></pre>
</details>
</dd>
<dt id="helpers.checkCreator"><code class="name flex">
<span>def <span class="ident">checkCreator</span></span>(<span>table, eid, user)</span>
</code></dt>
<dd>
<section class="desc"><p>Checks whether a user is the creator of a record.</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>table</code></strong> :&ensp;<code>string</code></dt>
<dd>&nbsp;</dd>
</dl>
<h2 id="returns">Returns</h2></section>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def checkCreator(table, eid, user):
    &#34;&#34;&#34;Checks whether a user is the creator of a record.

    Parameters
    ----------
    table: string

    Returns
    -------
    &#34;&#34;&#34;
    client = MongoClient()
    mongo = client.dariah_test
    userId = G(list(mongo.user.find(dict(eppn=user)))[0], _ID)
    records = list(mongo[table].find(dict(_id=ObjectId(eid), creator=userId)))
    return len(records) &gt; 0</code></pre>
</details>
</dd>
<dt id="helpers.checkWarning"><code class="name flex">
<span>def <span class="ident">checkWarning</span></span>(<span>text, label)</span>
</code></dt>
<dd>
<section class="desc"><p>Whether there is a warned item with <code>label</code>.</p>
<p>See <a title="helpers.reWarning" href="#helpers.reWarning"><code>reWarning()</code></a>.</p></section>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def checkWarning(text, label):
    &#34;&#34;&#34;Whether there is a warned item with `label`.

    See `reWarning`.
    &#34;&#34;&#34;

    return not not reWarning(label).search(text)</code></pre>
</details>
</dd>
<dt id="helpers.findCaptions"><code class="name flex">
<span>def <span class="ident">findCaptions</span></span>(<span>text)</span>
</code></dt>
<dd>
<section class="desc"><p>Get the captions from a response.</p>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>They are neatly packaged in comment lines!</p>
</div>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>text</code></strong> :&ensp;<code>string</code></dt>
<dd>The response text.</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>list</code> of <code>string</code></dt>
<dd>&nbsp;</dd>
</dl></section>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def findCaptions(text):
    &#34;&#34;&#34;Get the captions from a response.

    !!! hint
        They are neatly packaged in comment lines!

    Parameters
    ----------
    text: string
        The response text.

    Returns
    -------
    list of string
    &#34;&#34;&#34;

    return captionRe.findall(text)</code></pre>
</details>
</dd>
<dt id="helpers.findDetails"><code class="name flex">
<span>def <span class="ident">findDetails</span></span>(<span>text, dtable)</span>
</code></dt>
<dd>
<section class="desc"><p>Get the details from a response, but only those in a specific table.</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>text</code></strong> :&ensp;<code>string</code></dt>
<dd>The response text.</dd>
<dt><strong><code>dtail</code></strong> :&ensp;<code>string</code></dt>
<dd>The detail table</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>list</code> of <code>tuple</code> of (<code>string</code>(<code>id</code>), <code>string</code>(<code>html</code>))</dt>
<dd>
<p>The HTML for the details, chunked per detail record.
Each chunk consists of the following parts:</p>
<ul>
<li>the entity id of that detail,</li>
<li>the piece of HTML representing the title of the detail.</li>
</ul>
</dd>
</dl></section>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def findDetails(text, dtable):
    &#34;&#34;&#34;Get the details from a response, but only those in a specific table.

    Parameters
    ----------
    text: string
        The response text.
    dtail: string
        The detail table

    Returns
    -------
    list of tuple of (string(id), string(html))
        The HTML for the details, chunked per detail record.
        Each chunk consists of the following parts:

        *   the entity id of that detail,
        *   the piece of HTML representing the title of the detail.
    &#34;&#34;&#34;

    result = []
    for (eid, mat) in reDetail(dtable).findall(text):
        result.append((eid, mat))
    return result</code></pre>
</details>
</dd>
<dt id="helpers.findEid"><code class="name flex">
<span>def <span class="ident">findEid</span></span>(<span>text, multiple=False)</span>
</code></dt>
<dd>
<section class="desc"><p>Get the entity id(s) from a response.</p>
<p>If the response shows a record, dig out its entity id.</p>
<p>Otherwise, return <code>None</code></p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>text</code></strong> :&ensp;<code>string</code></dt>
<dd>The response text.</dd>
<dt><strong><code>multiple</code></strong> :&ensp;<code>boolean</code></dt>
<dd>Whether we should return the list of all found ids or only the first one.</dd>
</dl>
<h2 id="returns">Returns</h2>
<p>list of string(ObjectId) | string(ObjectId) | <code>None</code></p></section>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def findEid(text, multiple=False):
    &#34;&#34;&#34;Get the entity id(s) from a response.

    If the response shows a record, dig out its entity id.

    Otherwise, return `None`

    Parameters
    ----------
    text: string
        The response text.
    multiple: boolean
        Whether we should return the list of all found ids or only the first one.

    Returns
    -------
    list of string(ObjectId) | string(ObjectId) | `None`
    &#34;&#34;&#34;

    results = eidRe.findall(text)
    return results if multiple else results[0] if results else None</code></pre>
</details>
</dd>
<dt id="helpers.findFields"><code class="name flex">
<span>def <span class="ident">findFields</span></span>(<span>text)</span>
</code></dt>
<dd>
<section class="desc"><p>Get the fields from a response.</p>
<p>If the response shows a record, dig out its fields and values.</p>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>They are neatly packaged in comment lines!</p>
</div>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>text</code></strong> :&ensp;<code>string</code></dt>
<dd>The response text.</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>dict</code></dt>
<dd>Keyed by field names, valued by field values.</dd>
</dl></section>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def findFields(text):
    &#34;&#34;&#34;Get the fields from a response.

    If the response shows a record, dig out its fields and values.

    !!! hint
        They are neatly packaged in comment lines!

    Parameters
    ----------
    text: string
        The response text.

    Returns
    -------
    dict
        Keyed by field names, valued by field values.
    &#34;&#34;&#34;

    return {field: value for (field, value) in fieldRe.findall(text)}</code></pre>
</details>
</dd>
<dt id="helpers.findMainN"><code class="name flex">
<span>def <span class="ident">findMainN</span></span>(<span>text)</span>
</code></dt>
<dd>
<section class="desc"><p>Get the number of main records from a response.</p>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>They are neatly packaged in comment lines!</p>
</div>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>text</code></strong> :&ensp;<code>string</code></dt>
<dd>The response text.</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>list</code> of <code>string</code></dt>
<dd>&nbsp;</dd>
</dl></section>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def findMainN(text):
    &#34;&#34;&#34;Get the number of main records from a response.

    !!! hint
        They are neatly packaged in comment lines!

    Parameters
    ----------
    text: string
        The response text.

    Returns
    -------
    list of string
    &#34;&#34;&#34;

    return mainNRe.findall(text)</code></pre>
</details>
</dd>
<dt id="helpers.findMsg"><code class="name flex">
<span>def <span class="ident">findMsg</span></span>(<span>text)</span>
</code></dt>
<dd>
<section class="desc"><p>Get flashed messages from a response.</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>text</code></strong> :&ensp;<code>string</code></dt>
<dd>The response text.</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>set</code></dt>
<dd>All text messages found in the flash bar.</dd>
</dl></section>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def findMsg(text):
    &#34;&#34;&#34;Get flashed messages from a response.

    Parameters
    ----------
    text: string
        The response text.

    Returns
    -------
    set
        All text messages found in the flash bar.
    &#34;&#34;&#34;

    return set(msgRe.findall(text))</code></pre>
</details>
</dd>
<dt id="helpers.findReviewEntries"><code class="name flex">
<span>def <span class="ident">findReviewEntries</span></span>(<span>text)</span>
</code></dt>
<dd>
<section class="desc"><p>Get review entries from a criteria entry record.</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>text</code></strong> :&ensp;<code>string</code></dt>
<dd>The response text of a request for an item view on a criteriaEntry record.</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>dict</code></dt>
<dd>Keyed by <code>expert</code> or <code>final</code>. The values are the review comments of that
reviewer on this criteria entry.</dd>
</dl></section>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def findReviewEntries(text):
    &#34;&#34;&#34;Get review entries from a criteria entry record.

    Parameters
    ----------
    text: string
        The response text of a request for an item view on a criteriaEntry record.

    Returns
    -------
    dict
        Keyed by `expert` or `final`. The values are the review comments of that
        reviewer on this criteria entry.
    &#34;&#34;&#34;

    result = {}
    for (kind, material) in reviewRe.findall(text):
        spans = reviewEntryIdRe.findall(material)
        if spans:
            reIds = idRe.findall(spans[0])
            if reIds:
                reId = reIds[0]
                fields = findFields(material)
                result[kind] = (reId, fields)
    return result</code></pre>
</details>
</dd>
<dt id="helpers.findStages"><code class="name flex">
<span>def <span class="ident">findStages</span></span>(<span>text)</span>
</code></dt>
<dd>
<section class="desc"><p>Get the workflow stages from a response.</p>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>They are neatly packaged in comment lines!</p>
</div>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>text</code></strong> :&ensp;<code>string</code></dt>
<dd>The response text.</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>list</code> of <code>string</code></dt>
<dd>&nbsp;</dd>
</dl></section>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def findStages(text):
    &#34;&#34;&#34;Get the workflow stages from a response.

    !!! hint
        They are neatly packaged in comment lines!

    Parameters
    ----------
    text: string
        The response text.

    Returns
    -------
    list of string
    &#34;&#34;&#34;

    return stageRe.findall(text)</code></pre>
</details>
</dd>
<dt id="helpers.findTasks"><code class="name flex">
<span>def <span class="ident">findTasks</span></span>(<span>text)</span>
</code></dt>
<dd>
<section class="desc"><p>Get the workflow tasks from a response.</p>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>They are neatly packaged in comment lines!</p>
</div>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>text</code></strong> :&ensp;<code>string</code></dt>
<dd>The response text.</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>list</code> of <code>string</code></dt>
<dd>&nbsp;</dd>
</dl></section>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def findTasks(text):
    &#34;&#34;&#34;Get the workflow tasks from a response.

    !!! hint
        They are neatly packaged in comment lines!

    Parameters
    ----------
    text: string
        The response text.

    Returns
    -------
    list of string
    &#34;&#34;&#34;

    return taskRe.findall(text)</code></pre>
</details>
</dd>
<dt id="helpers.findValues"><code class="name flex">
<span>def <span class="ident">findValues</span></span>(<span>table, text)</span>
</code></dt>
<dd>
<section class="desc"><p>Get the values from the response of a list view on that table.</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>table</code></strong> :&ensp;<code>string</code></dt>
<dd>&nbsp;</dd>
<dt><strong><code>text</code></strong> :&ensp;<code>string</code></dt>
<dd>The response text.</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>dict</code></dt>
<dd>keyed by the titles of the records and valued by their ids.</dd>
</dl></section>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def findValues(table, text):
    &#34;&#34;&#34;Get the values from the response of a list view on that table.

    Parameters
    ----------
    table: string
    text: string
        The response text.

    Returns
    -------
    dict
        keyed by the titles of the records and valued by their ids.
    &#34;&#34;&#34;

    return {name: eid for (eid, name) in reValueList(table).findall(text)}</code></pre>
</details>
</dd>
<dt id="helpers.forall"><code class="name flex">
<span>def <span class="ident">forall</span></span>(<span>cls, expect, assertFunc, *args)</span>
</code></dt>
<dd>
<section class="desc"><p>Executes an assert function for a subset of all clients.</p>
<p>The subset is determined by <code>expect</code>, which holds expected outcomes
for the clients.</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>cls</code></strong> :&ensp;<code>fixture</code></dt>
<dd>Contains a dict of all clients: <a title="conftest.clients" href="conftest.html#conftest.clients"><code>clients()</code></a></dd>
<dt><strong><code>assertFunc</code></strong> :&ensp;<code>function</code></dt>
<dd>The function to be applied for each client.
It will be passed all the <code>args</code> and a relevant part of <code>expect</code></dd>
<dt><strong><code>expect</code></strong> :&ensp;<code>dict</code></dt>
<dd>Keyed by user (eppn), contains the expected value for that user.</dd>
</dl></section>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def forall(cls, expect, assertFunc, *args):
    &#34;&#34;&#34;Executes an assert function for a subset of all clients.

    The subset is determined by `expect`, which holds expected outcomes
    for the clients.

    Parameters
    ----------
    cls: fixture
        Contains a dict of all clients: `conftest.clients`
    assertFunc: function
        The function to be applied for each client.
        It will be passed all the `args` and a relevant part of `expect`
    expect: dict
        Keyed by user (eppn), contains the expected value for that user.
    &#34;&#34;&#34;

    for user in USER_LIST:
        if user not in expect:
            continue
        exp = expect[user]
        serverprint(f&#34;USER {user} EXPECTS {exp}&#34;)
        assertFunc(cls[user], *args, exp)</code></pre>
</details>
</dd>
<dt id="helpers.getEid"><code class="name flex">
<span>def <span class="ident">getEid</span></span>(<span>client, table, multiple=False)</span>
</code></dt>
<dd>
<section class="desc"><p>Gets the id(s) of the records(s) in the mylist view.</p>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p>Not all tables have a <code>mylist</code> view. Only contributions, assessments
and reviews.</p>
</div>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>table</code></strong> :&ensp;<code>string</code></dt>
<dd>&nbsp;</dd>
</dl></section>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def getEid(client, table, multiple=False):
    &#34;&#34;&#34;Gets the id(s) of the records(s) in the mylist view.

    !!! caution
        Not all tables have a `mylist` view. Only contributions, assessments
        and reviews.

    Parameters
    ----------
    table: string
    &#34;&#34;&#34;

    url = f&#34;/{table}/list?action=my&#34;
    (text, status, msgs) = accessUrl(client, url, redirect=True)
    return findEid(text, multiple=multiple)</code></pre>
</details>
</dd>
<dt id="helpers.getItem"><code class="name flex">
<span>def <span class="ident">getItem</span></span>(<span>client, table, eid)</span>
</code></dt>
<dd>
<section class="desc"><p>Looks up an item directly.</p>
<p>The response texts will be analysed into messages and fields, the eid
of the item will be read off.</p>
<p>We assume that there is still only one item in the view.</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><a title="client" href="client.html"><code>client</code></a></strong> :&ensp;<code>fixture</code></dt>
<dd>&nbsp;</dd>
<dt><strong><code>table</code></strong> :&ensp;<code>string</code></dt>
<dd>&nbsp;</dd>
<dt><strong><code>action</code></strong> :&ensp;<code>string</code>, optional <code>None</code></dt>
<dd>The view on the table, such as <code>my</code>, <code>our</code>.</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><strong><code>text</code></strong> :&ensp;<code>string</code></dt>
<dd>The complete response text</dd>
<dt><strong><code>fields</code></strong> :&ensp;<code>dict</code></dt>
<dd>All fields and their values</dd>
<dt><strong><code>msgs</code></strong> :&ensp;<code>list</code></dt>
<dd>All entries that have been flashed (and arrived in the flash bar)</dd>
<dt><strong><code>eid</code></strong> :&ensp;<code>str</code>(<code>ObjectId</code>)</dt>
<dd>The id of the item.</dd>
</dl></section>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def getItem(client, table, eid):
    &#34;&#34;&#34;Looks up an item directly.

    The response texts will be analysed into messages and fields, the eid
    of the item will be read off.

    We assume that there is still only one item in the view.

    Parameters
    ----------
    client: fixture
    table: string
    action: string, optional `None`
        The view on the table, such as `my`, `our`.

    Returns
    -------
    text: string
        The complete response text
    fields: dict
        All fields and their values
    msgs: list
        All entries that have been flashed (and arrived in the flash bar)
    eid: str(ObjectId)
        The id of the item.
    &#34;&#34;&#34;

    url = f&#34;/{table}/item/{eid}&#34;
    response = client.get(url)
    text = response.get_data(as_text=True)
    fields = {field: value for (field, value) in fieldRe.findall(text)}
    msgs = findMsg(text)
    eid = findEid(text)
    return (text, fields, msgs, eid)</code></pre>
</details>
</dd>
<dt id="helpers.getItemEids"><code class="name flex">
<span>def <span class="ident">getItemEids</span></span>(<span>client, table, action=None)</span>
</code></dt>
<dd>
<section class="desc"><p>Looks up item eids from a view on a table.</p>
<p>The response texts will be analysed into messages and fields, the eids
of the items will be read off.</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><a title="client" href="client.html"><code>client</code></a></strong> :&ensp;<code>fixture</code></dt>
<dd>&nbsp;</dd>
<dt><strong><code>table</code></strong> :&ensp;<code>string</code></dt>
<dd>&nbsp;</dd>
<dt><strong><code>action</code></strong> :&ensp;<code>string</code>, optional <code>None</code></dt>
<dd>The view on the table, such as <code>my</code>, <code>our</code>.</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><strong><code>eid</code></strong> :&ensp;<code>list</code> of <code>str</code>(<code>ObjectId</code>)</dt>
<dd>The ids of the item that can be found.</dd>
</dl></section>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def getItemEids(client, table, action=None):
    &#34;&#34;&#34;Looks up item eids from a view on a table.

    The response texts will be analysed into messages and fields, the eids
    of the items will be read off.

    Parameters
    ----------
    client: fixture
    table: string
    action: string, optional `None`
        The view on the table, such as `my`, `our`.

    Returns
    -------
    eid: list of str(ObjectId)
        The ids of the item that can be found.
    &#34;&#34;&#34;

    actionStr = &#34;&#34; if action is None else f&#34;?action={action}&#34;
    response = client.get(f&#34;/{table}/list{actionStr}&#34;)
    text = response.get_data(as_text=True)
    return findEid(text, multiple=True)</code></pre>
</details>
</dd>
<dt id="helpers.getREIds"><code class="name flex">
<span>def <span class="ident">getREIds</span></span>(<span>clients, cId, direct=None)</span>
</code></dt>
<dd>
<section class="desc"><p>Get the review entries associated with a criteria entry.</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>clients</code></strong> :&ensp;<code>dict</code></dt>
<dd>Keyed by user eppns, values by the corresponding client fixtures</dd>
<dt><strong><code>cId</code></strong> :&ensp;<code>string</code>(<code>ObjectId</code>)</dt>
<dd>The id of the criteria entry in question</dd>
<dt><strong><code>direct</code></strong> :&ensp;<code>tuple</code> of <code>ObjectId</code>, optional, <code>None</code></dt>
<dd>If <code>None</code>, the review entries ids are peeled from a response text.
If present, it is a pair of review ids, the first of an expert review,
the second of a final review. These ids are used in a MongoDB query to get
the corresponding review entries.</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>dict</code></dt>
<dd>Keyed by reviewer (<code>expert</code> or <code>final</code>), the values are the ids of the
corresponding review entries.</dd>
</dl></section>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def getREIds(clients, cId, direct=None):
    &#34;&#34;&#34;Get the review entries associated with a criteria entry.

    Parameters
    ----------
    clients: dict
        Keyed by user eppns, values by the corresponding client fixtures
    cId: string(ObjectId)
        The id of the criteria entry in question
    direct: tuple of ObjectId, optional, `None`
        If `None`, the review entries ids are peeled from a response text.
        If present, it is a pair of review ids, the first of an expert review,
        the second of a final review. These ids are used in a MongoDB query to get
        the corresponding review entries.

    Returns
    -------
    dict
        Keyed by reviewer (`expert` or `final`), the values are the ids of the
        corresponding review entries.
    &#34;&#34;&#34;

    reId = {}
    if direct:
        client = MongoClient()
        mongo = client.dariah_test
        (rEId, rFId) = direct
        reId = {u: G(
            list(
                mongo[REVIEW_ENTRY].find(
                    {REVIEW: ObjectId(reid), CRITERIA_ENTRY: ObjectId(cId)}
                )
            )[0],
            _ID,
        ) for (u, reid) in zip((EXPERT, FINAL), direct)}
    else:
        for user in {EXPERT, FINAL}:
            (text, fields, msgs, dummy) = getItem(clients[user], CRITERIA_ENTRY, cId)
            reviewEntries = findReviewEntries(text)
            reId[user] = reviewEntries[user][0]
    return reId</code></pre>
</details>
</dd>
<dt id="helpers.getRelatedValues"><code class="name flex">
<span>def <span class="ident">getRelatedValues</span></span>(<span>client, table, eid, field)</span>
</code></dt>
<dd>
<section class="desc"><p>Get an editable view on a field that represents a related value.""</p>
<p>We check the contents.</p></section>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def getRelatedValues(client, table, eid, field):
    &#34;&#34;&#34;Get an editable view on a field that represents a related value.&#34;&#34;

    We check the contents.
    &#34;&#34;&#34;
    url = f&#34;/api/{table}/item/{eid}/field/{field}?action=edit&#34;
    response = client.get(url)
    text = response.get_data(as_text=True)
    thisRe = reEditField(eid, field)
    valueStr = thisRe.findall(text)
    values = valueRe.findall(valueStr[0])
    valueDict = {value: eid for (eid, value) in values}
    return valueDict</code></pre>
</details>
</dd>
<dt id="helpers.getScores"><code class="name flex">
<span>def <span class="ident">getScores</span></span>(<span>cId)</span>
</code></dt>
<dd>
<section class="desc"><p>Get relevant scores directly from Mongo DB.</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>cId</code></strong> :&ensp;<code>string</code>(<code>ObjectId</code>)</dt>
<dd>The id of a criteria entry record whose set of possible scores we
want to retrieve.</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>dict</code></dt>
<dd>Keyed by the title of the score, values are their ids.</dd>
</dl></section>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def getScores(cId):
    &#34;&#34;&#34;Get relevant scores directly from Mongo DB.

    Parameters
    ----------
    cId: string(ObjectId)
        The id of a criteria entry record whose set of possible scores we
        want to retrieve.

    Returns
    -------
    dict
        Keyed by the title of the score, values are their ids.
    &#34;&#34;&#34;
    client = MongoClient()
    mongo = client.dariah_test
    crId = G(list(mongo.criteriaEntry.find(dict(_id=ObjectId(cId))))[0], CRITERIA)
    scores = mongo.score.find(dict(criteria=ObjectId(crId)))
    result = {}
    for record in scores:
        score = G(record, SCORE)
        if score is None:
            return UNDEF_VALUE
        level = G(record, LEVEL) or UNDEF_VALUE
        title = f&#34;&#34;&#34;{score} - {level}&#34;&#34;&#34;
        result[title] = str(G(record, _ID))
    return result</code></pre>
</details>
</dd>
<dt id="helpers.modifyField"><code class="name flex">
<span>def <span class="ident">modifyField</span></span>(<span>client, table, eid, field, newValue)</span>
</code></dt>
<dd>
<section class="desc"><p>Post data to update a field and analyse the response for the effect.</p></section>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def modifyField(client, table, eid, field, newValue):
    &#34;&#34;&#34;Post data to update a field and analyse the response for the effect.&#34;&#34;&#34;

    url = f&#34;/api/{table}/item/{eid}/field/{field}?action=view&#34;
    text = postJson(client, url, newValue)
    fields = findFields(text)
    return (text, fields)</code></pre>
</details>
</dd>
<dt id="helpers.postJson"><code class="name flex">
<span>def <span class="ident">postJson</span></span>(<span>client, url, value)</span>
</code></dt>
<dd>
<section class="desc"><p>Post data to a url and retrieve the response text.</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><a title="client" href="client.html"><code>client</code></a></strong> :&ensp;<code>function</code></dt>
<dd>&nbsp;</dd>
<dt><strong><code>url</code></strong> :&ensp;<code>string</code>(<code>url</code>)</dt>
<dd>&nbsp;</dd>
<dt><strong><code>value</code></strong> :&ensp;<code>mixed</code></dt>
<dd>The value to post.
Will be wrapped into JSON with a proper header.</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>string</code></dt>
<dd>The response text</dd>
</dl></section>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def postJson(client, url, value):
    &#34;&#34;&#34;Post data to a url and retrieve the response text.

    Parameters
    ----------
    client: function
    url: string(url)
    value: mixed
        The value to post.
        Will be wrapped into JSON with a proper header.

    Returns
    -------
    string
        The response text
    &#34;&#34;&#34;

    response = client.post(
        url, data=json.dumps(dict(save=value)), content_type=&#34;application/json&#34;,
    )
    text = response.get_data(as_text=True)

    return text</code></pre>
</details>
</dd>
<dt id="helpers.reDetail"><code class="name flex">
<span>def <span class="ident">reDetail</span></span>(<span>dtable)</span>
</code></dt>
<dd>
<section class="desc"><p>Given a detail table name, return a <code>re</code> that looks for the detail records.</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>dtable</code></strong> :&ensp;<code>string</code></dt>
<dd>&nbsp;</dd>
</dl></section>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def reDetail(dtable):
    &#34;&#34;&#34;Given a detail table name, return a `re` that looks for the detail records.

    Parameters
    ----------
    dtable: string
    &#34;&#34;&#34;

    return re.compile(
        r&#34;&#34;&#34;&lt;details itemkey=[&#39;&#34;]{dtable}/([^&#39;&#34;]+)[&#39;&#34;][^&gt;]*&gt;(.*?)&lt;/details&gt;&#34;&#34;&#34;.format(
            dtable=dtable
        ),
        re.S,
    )</code></pre>
</details>
</dd>
<dt id="helpers.reEditField"><code class="name flex">
<span>def <span class="ident">reEditField</span></span>(<span>eid, field)</span>
</code></dt>
<dd>
<section class="desc"><p>Given a field name, return a <code>re</code> that looks for the value of that field.</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>eid</code></strong> :&ensp;<code>string</code>(<code>ObjectId</code>)</dt>
<dd>The id of the record whose field data we are searching</dd>
<dt><strong><code>field</code></strong> :&ensp;<code>string</code></dt>
<dd>&nbsp;</dd>
</dl></section>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def reEditField(eid, field):
    &#34;&#34;&#34;Given a field name, return a `re` that looks for the value of that field.

    Parameters
    ----------
    eid: string(ObjectId)
        The id of the record whose field data we are searching
    field: string
    &#34;&#34;&#34;

    return re.compile(
        r&#34;&#34;&#34;
    &lt;span\ [^&gt;]*?eid=[&#39;&#34;]{eid}[&#39;&#34;]\s+field=[&#39;&#34;]{field}[&#39;&#34;].*?
    &lt;div\ wtype=[&#39;&#34;]related[&#39;&#34;]\ .*?
    &lt;div\ class=[&#39;&#34;]wvalue[&#39;&#34;]&gt;(.*?)&lt;/div&gt;
    &#34;&#34;&#34;.format(
            eid=eid, field=field
        ),
        re.S | re.X,
    )</code></pre>
</details>
</dd>
<dt id="helpers.reValueList"><code class="name flex">
<span>def <span class="ident">reValueList</span></span>(<span>table)</span>
</code></dt>
<dd>
<section class="desc"><p>Given a table name, return a <code>re</code> that finds pairs of id and title strings.</p>
<p>The text is a list display of value records, and we peel the ids from the
<code>&lt;detail&gt;</code> elements and the titles from the <code>&lt;summary&gt;</code> within them.</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>table</code></strong> :&ensp;<code>string</code></dt>
<dd>&nbsp;</dd>
</dl></section>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def reValueList(table):
    &#34;&#34;&#34;Given a table name, return a `re` that finds pairs of id and title strings.

    The text is a list display of value records, and we peel the ids from the
    `&lt;detail&gt;` elements and the titles from the `&lt;summary&gt;` within them.

    Parameters
    ----------
    table: string
    &#34;&#34;&#34;

    return re.compile(
        f&#34;&#34;&#34;&lt;details itemkey=[&#39;&#34;]{table}/([^&#39;&#34;]*)[&#39;&#34;].*?&lt;summary&gt;.*?&lt;span.*?&gt;([^&lt;]*)&lt;/span&gt;&#34;&#34;&#34;,
        re.S,
    )</code></pre>
</details>
</dd>
<dt id="helpers.reWarning"><code class="name flex">
<span>def <span class="ident">reWarning</span></span>(<span>label)</span>
</code></dt>
<dd>
<section class="desc"><p>Given a label, return a <code>re</code> that looks for warned items with that label.</p>
<p>A warned item is an item with a CSS class <code>warning</code> in it.</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>label</code></strong> :&ensp;<code>string</code></dt>
<dd>Usually the title of an item</dd>
</dl></section>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def reWarning(label):
    &#34;&#34;&#34;Given a label, return a `re` that looks for warned items with that label.

    A warned item is an item with a CSS class `warning` in it.

    Parameters
    ----------
    label: string
        Usually the title of an item
    &#34;&#34;&#34;

    return re.compile(
        r&#34;&#34;&#34;\bclass=[&#39;&#34;][^&#39;&#34;]*\bwarning\b[^&#39;&#34;]*[&#39;&#34;][^&gt;]*&gt;{label}&lt;&#34;&#34;&#34;.format(
            label=label
        ),
        re.S,
    )</code></pre>
</details>
</dd>
<dt id="helpers.viewField"><code class="name flex">
<span>def <span class="ident">viewField</span></span>(<span>client, table, eid, field)</span>
</code></dt>
<dd>
<section class="desc"><p>Get the response for showing a field.</p></section>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def viewField(client, table, eid, field):
    &#34;&#34;&#34;Get the response for showing a field.&#34;&#34;&#34;

    url = f&#34;/api/{table}/item/{eid}/field/{field}?action=view&#34;
    response = client.get(url)
    text = response.get_data(as_text=True)
    fields = findFields(text)
    return (text, fields)</code></pre>
</details>
</dd>
</dl>
</section>
<section>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3><a href="#header-functions">Functions</a></h3>
<ul class="two-column">
<li><code><a title="helpers.accessUrl" href="#helpers.accessUrl">accessUrl</a></code></li>
<li><code><a title="helpers.checkCreator" href="#helpers.checkCreator">checkCreator</a></code></li>
<li><code><a title="helpers.checkWarning" href="#helpers.checkWarning">checkWarning</a></code></li>
<li><code><a title="helpers.findCaptions" href="#helpers.findCaptions">findCaptions</a></code></li>
<li><code><a title="helpers.findDetails" href="#helpers.findDetails">findDetails</a></code></li>
<li><code><a title="helpers.findEid" href="#helpers.findEid">findEid</a></code></li>
<li><code><a title="helpers.findFields" href="#helpers.findFields">findFields</a></code></li>
<li><code><a title="helpers.findMainN" href="#helpers.findMainN">findMainN</a></code></li>
<li><code><a title="helpers.findMsg" href="#helpers.findMsg">findMsg</a></code></li>
<li><code><a title="helpers.findReviewEntries" href="#helpers.findReviewEntries">findReviewEntries</a></code></li>
<li><code><a title="helpers.findStages" href="#helpers.findStages">findStages</a></code></li>
<li><code><a title="helpers.findTasks" href="#helpers.findTasks">findTasks</a></code></li>
<li><code><a title="helpers.findValues" href="#helpers.findValues">findValues</a></code></li>
<li><code><a title="helpers.forall" href="#helpers.forall">forall</a></code></li>
<li><code><a title="helpers.getEid" href="#helpers.getEid">getEid</a></code></li>
<li><code><a title="helpers.getItem" href="#helpers.getItem">getItem</a></code></li>
<li><code><a title="helpers.getItemEids" href="#helpers.getItemEids">getItemEids</a></code></li>
<li><code><a title="helpers.getREIds" href="#helpers.getREIds">getREIds</a></code></li>
<li><code><a title="helpers.getRelatedValues" href="#helpers.getRelatedValues">getRelatedValues</a></code></li>
<li><code><a title="helpers.getScores" href="#helpers.getScores">getScores</a></code></li>
<li><code><a title="helpers.modifyField" href="#helpers.modifyField">modifyField</a></code></li>
<li><code><a title="helpers.postJson" href="#helpers.postJson">postJson</a></code></li>
<li><code><a title="helpers.reDetail" href="#helpers.reDetail">reDetail</a></code></li>
<li><code><a title="helpers.reEditField" href="#helpers.reEditField">reEditField</a></code></li>
<li><code><a title="helpers.reValueList" href="#helpers.reValueList">reValueList</a></code></li>
<li><code><a title="helpers.reWarning" href="#helpers.reWarning">reWarning</a></code></li>
<li><code><a title="helpers.viewField" href="#helpers.viewField">viewField</a></code></li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc"><cite>pdoc</cite> 0.7.2</a>.</p>
</footer>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad()</script>
</body>
</html>