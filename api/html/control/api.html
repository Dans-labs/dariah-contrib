<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.10.0" />
<title>control.api API documentation</title>
<meta name="description" content="Overview page of contributions â€¦" />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>control.api</code></h1>
</header>
<section id="section-intro">
<p>Overview page of contributions.</p>
<ul>
<li>Country selection</li>
<li>Grouping by categories</li>
<li>Statistics</li>
</ul>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">&#34;&#34;&#34;Overview page of contributions.

*   Country selection
*   Grouping by categories
*   Statistics
&#34;&#34;&#34;

from flask import make_response

from config import Names as N
from control.utils import mjson, mktsv, pick as G, serverprint
from control.table import Table, SENSITIVE_TABLES, SENSITIVE_FIELDS
from control.typ.related import castObjectId


REVIEWED1 = &#34;reviewed1&#34;
REVIEWED2 = &#34;reviewed2&#34;
R1RANK = &#34;r1Rank&#34;
R2RANK = &#34;r2Rank&#34;

ASSESSED_STATUS = {
    None: (&#34;no assessment&#34;, &#34;a-none&#34;),
    N.incomplete: (&#34;started&#34;, &#34;a-started&#34;),
    N.incompleteRevised: (&#34;revision&#34;, &#34;a-started&#34;),
    N.incompleteWithdrawn: (&#34;withdrawn&#34;, &#34;a-none&#34;),
    N.complete: (&#34;filled-in&#34;, &#34;a-self&#34;),
    N.completeRevised: (&#34;revised&#34;, &#34;a-self&#34;),
    N.completeWithdrawn: (&#34;withdrawn&#34;, &#34;a-none&#34;),
    N.submitted: (&#34;in review&#34;, &#34;a-inreview&#34;),
    N.submittedRevised: (&#34;in review&#34;, &#34;a-inreview&#34;),
    N.reviewReject: (&#34;rejected&#34;, &#34;a-rejected&#34;),
    N.reviewAccept: (&#34;accepted&#34;, &#34;a-accepted&#34;),
}
ASSESSED_LABELS = {stage: info[0] for (stage, info) in ASSESSED_STATUS.items()}
ASSESSED_CLASS = {stage: info[1] for (stage, info) in ASSESSED_STATUS.items()}
ASSESSED_CLASS1 = {info[0]: info[1] for info in ASSESSED_STATUS.values()}
ASSESSED_DEFAULT_CLASS = ASSESSED_STATUS[None][1]
ASSESSED_RANK = {stage: i for (i, stage) in enumerate(ASSESSED_STATUS)}

NO_REVIEW = {
    N.incomplete,
    N.incompleteRevised,
    N.incompleteWithdrawn,
    N.complete,
    N.completeRevised,
    N.completeWithdrawn,
}
IN_REVIEW = {
    N.submitted,
    N.submittedRevised,
}
ADVISORY_REVIEW = {
    N.reviewAdviseAccept,
    N.reviewAdviseReject,
    N.reviewAdviseRevise,
}
FINAL_REVIEW = {
    N.reviewAccept,
    N.reviewReject,
    N.reviewRevise,
}


REVIEWED_STATUS = {
    None: (&#34;&#34;, &#34;r-none&#34;),
    &#34;noReview&#34;: (&#34;not reviewable&#34;, &#34;r-noreview&#34;),
    &#34;inReview&#34;: (&#34;in review&#34;, &#34;r-inreview&#34;),
    &#34;skipReview&#34;: (&#34;review skipped&#34;, &#34;r-skipreview&#34;),
    N.reviewAdviseReject: (&#34;rejected&#34;, &#34;r-rejected&#34;),
    N.reviewAdviseAccept: (&#34;accepted&#34;, &#34;r-accepted&#34;),
    N.reviewAdviseRevise: (&#34;revise&#34;, &#34;r-revised&#34;),
    N.reviewReject: (&#34;rejected&#34;, &#34;r-rejected&#34;),
    N.reviewAccept: (&#34;accepted&#34;, &#34;r-accepted&#34;),
    N.reviewRevise: (&#34;revise&#34;, &#34;r-revised&#34;),
}
REVIEW_LABELS = {stage: info[0] for (stage, info) in REVIEWED_STATUS.items()}
REVIEW_CLASS = {stage: info[1] for (stage, info) in REVIEWED_STATUS.items()}
REVIEW_CLASS1 = {info[0]: info[1] for info in REVIEWED_STATUS.values()}
REVIEW_DEFAULT_CLASS = REVIEWED_STATUS[None][1]
REVIEW_RANK = {stage: i for (i, stage) in enumerate(REVIEWED_STATUS)}


class Api:
    def __init__(self, context):
        self.context = context

        types = context.types
        self.countryType = types.country
        self.yearType = types.year
        self.typeType = types.typeContribution
        self.headers = dict(
            json={
                &#34;Expires&#34;: &#34;0&#34;,
                &#34;Cache-Control&#34;: &#34;no-cache, no-store, must-revalidate&#34;,
                &#34;Content-Type&#34;: &#34;application/json&#34;,
                &#34;Content-Encoding&#34;: &#34;utf-8&#34;,
            },
            tsv={
                &#34;Expires&#34;: &#34;0&#34;,
                &#34;Cache-Control&#34;: &#34;no-cache, no-store, must-revalidate&#34;,
                &#34;Content-Type&#34;: &#34;text/tab-separated-values&#34;,
                &#34;Content-Encoding&#34;: &#34;utf-8&#34;,
            },
        )

    def notimplemented(self, verb):
        serverprint(f&#34;Invalid api call requested: {verb}&#34;)
        return make_response(mjson(None), self.headers[&#34;json&#34;])

    def list(self, givenTable):
        parts = givenTable.rsplit(&#34;.&#34;, 1)
        if len(parts) == 1:
            table = givenTable
            ext = &#34;json&#34;
        else:
            (table, ext) = parts
        if ext not in {&#34;json&#34;, &#34;tsv&#34;}:
            serverprint(f&#34;Invalid extension: {ext} in {givenTable}&#34;)
            return make_response(mjson(None), self.headers[&#34;json&#34;])

        data = None
        if table is not None and table not in SENSITIVE_TABLES:
            if table == &#34;contrib&#34;:
                data = self.getContribs(ext)
            else:
                context = self.context
                tableObj = Table(context, table)
                data = tableObj.wrap(None, logical=True)
        if data is None:
            serverprint(f&#34;Non existing table requested: {table}&#34;)
        return make_response(
            mjson(data) if ext == &#34;json&#34; else mktsv(data), self.headers[ext]
        )

    def view(self, table, givenEid):
        record = None
        eid = castObjectId(givenEid)
        if table is not None and eid is not None and table not in SENSITIVE_TABLES:
            context = self.context
            tableObj = Table(context, table)
            recordObj = tableObj.record(eid=eid)
            record = recordObj.wrapLogical()
            if table == &#34;contrib&#34;:
                extra = self.getExtra(record)
                for (k, v) in extra.items():
                    record[k] = v
                for k in SENSITIVE_FIELDS:
                    if k in record:
                        del record[k]
                k = &#34;typeContribution&#34;
                if k in record:
                    record[&#34;type&#34;] = record[k]
                    del record[k]
        if record is None:
            serverprint(f&#34;Non existing record requested: {table}/{givenEid}&#34;)
        return make_response(mjson(record), self.headers[&#34;json&#34;])

    def getExtra(self, record):
        context = self.context
        wf = context.wf
        workflow = wf.computeWorkflow(record)

        selected = G(workflow, N.selected)
        aStage = G(workflow, N.aStage)
        r2Stage = G(workflow, N.r2Stage)
        if r2Stage in {N.reviewAccept, N.reviewReject}:
            aStage = r2Stage
        score = G(workflow, N.score)
        assessed = ASSESSED_STATUS[aStage][0]
        aRank = (G(ASSESSED_RANK, aStage, default=0), score or 0)
        if aStage != N.reviewAccept:
            score = None

        extra = {
            N.assessed: assessed,
            N.arank: aRank,
            N.astage: aStage,
            N.score: score,
            N.selected: selected,
        }
        preR1Stage = G(workflow, N.r1Stage)
        noReview = aStage is None or aStage in NO_REVIEW
        inReview = aStage in IN_REVIEW
        advReview = preR1Stage in ADVISORY_REVIEW
        r1Stage = (
            &#34;noReview&#34;
            if noReview
            else preR1Stage
            if advReview
            else &#34;inReview&#34;
            if inReview
            else &#34;skipReview&#34;
        )
        r2Stage = (
            &#34;noReview&#34;
            if noReview
            else &#34;inReview&#34;
            if inReview
            else G(workflow, N.r2Stage)
        )
        reviewed1 = REVIEWED_STATUS[r1Stage][0]
        reviewed2 = REVIEWED_STATUS[r2Stage][0]
        r1Rank = G(REVIEW_RANK, r1Stage, default=0)
        r2Rank = G(REVIEW_RANK, r2Stage, default=0)
        extra.update(
            {
                REVIEWED1: reviewed1,
                REVIEWED2: reviewed2,
                R1RANK: r1Rank,
                R2RANK: r2Rank,
                N.r1Stage: r1Stage,
                N.r2Stage: r2Stage,
            }
        )
        return extra

    def getContribs(self, ext):
        context = self.context
        db = context.db
        countryType = self.countryType
        yearType = self.yearType
        typeType = self.typeType

        asTsv = ext == &#34;tsv&#34;

        contribs = []

        if asTsv:
            contribsFull = {G(r, N._id): r for r in db.getList(N.contrib)}
            context = self.context
            tableObj = Table(context, N.contrib)

        for record in db.bulkContribWorkflow(None, False):
            title = G(record, N.title)
            contribId = G(record, N._id)

            selected = G(record, N.selected)
            aStage = G(record, N.aStage)
            r2Stage = G(record, N.r2Stage)
            if r2Stage in {N.reviewAccept, N.reviewReject}:
                aStage = r2Stage
            score = G(record, N.score)
            assessed = ASSESSED_STATUS[aStage][0]
            aRank = (G(ASSESSED_RANK, aStage, default=0), score or 0)
            if aStage != N.reviewAccept:
                score = None

            countryRep = countryType.titleStr(
                G(db.country, G(record, N.country)), markup=None
            )
            yearRep = yearType.titleStr(G(db.year, G(record, N.year)), markup=None)
            typeRep = typeType.titleStr(
                G(db.typeContribution, G(record, N.type)), markup=None
            )

            contribRecord = {
                N._id: contribId,
                N.country: countryRep,
                N.year: yearRep,
                N.type: typeRep,
                N.title: title,
                N.assessed: assessed,
                N.arank: aRank,
                N.astage: aStage,
                N.score: score,
                N.selected: selected,
            }
            preR1Stage = G(record, N.r1Stage)
            noReview = aStage is None or aStage in NO_REVIEW
            inReview = aStage in IN_REVIEW
            advReview = preR1Stage in ADVISORY_REVIEW
            r1Stage = (
                &#34;noReview&#34;
                if noReview
                else preR1Stage
                if advReview
                else &#34;inReview&#34;
                if inReview
                else &#34;skipReview&#34;
            )
            r2Stage = (
                &#34;noReview&#34;
                if noReview
                else &#34;inReview&#34;
                if inReview
                else G(record, N.r2Stage)
            )
            reviewed1 = REVIEWED_STATUS[r1Stage][0]
            reviewed2 = REVIEWED_STATUS[r2Stage][0]
            r1Rank = G(REVIEW_RANK, r1Stage, default=0)
            r2Rank = G(REVIEW_RANK, r2Stage, default=0)
            contribRecord.update(
                {
                    REVIEWED1: reviewed1,
                    REVIEWED2: reviewed2,
                    R1RANK: r1Rank,
                    R2RANK: r2Rank,
                    N.r1Stage: r1Stage,
                    N.r2Stage: r2Stage,
                }
            )
            if asTsv:
                fullObj = tableObj.record(record=G(contribsFull, contribId, {}))
                full = fullObj.wrapLogical()
                contribRecord.update({
                    N.dateDecided: G(full, N.dateDecided),
                    N.vcc: G(full, N.vcc),
                    N.description: G(full, N.description),
                    N.contactPersonName: G(full, N.contactPersonName),
                    N.contactPersonEmail: G(full, N.contactPersonEmail),
                    N.urlContribution: G(full, N.urlContribution),
                    N.urlAcademic: G(full, N.urlAcademic),
                    N.tadirahObject: G(full, N.tadirahObject),
                    N.tadirahActivity: G(full, N.tadirahActivity),
                    N.tadirahTechnique: G(full, N.tadirahTechnique),
                    N.keyword: G(full, N.keyword),
                    N.discipline: G(full, N.discipline),
                })
            contribs.append(contribRecord)

        return contribs</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-classes">Classes</h2>
<dl>
<dt id="control.api.Api"><code class="flex name class">
<span>class <span class="ident">Api</span></span>
<span>(</span><span>context)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class Api:
    def __init__(self, context):
        self.context = context

        types = context.types
        self.countryType = types.country
        self.yearType = types.year
        self.typeType = types.typeContribution
        self.headers = dict(
            json={
                &#34;Expires&#34;: &#34;0&#34;,
                &#34;Cache-Control&#34;: &#34;no-cache, no-store, must-revalidate&#34;,
                &#34;Content-Type&#34;: &#34;application/json&#34;,
                &#34;Content-Encoding&#34;: &#34;utf-8&#34;,
            },
            tsv={
                &#34;Expires&#34;: &#34;0&#34;,
                &#34;Cache-Control&#34;: &#34;no-cache, no-store, must-revalidate&#34;,
                &#34;Content-Type&#34;: &#34;text/tab-separated-values&#34;,
                &#34;Content-Encoding&#34;: &#34;utf-8&#34;,
            },
        )

    def notimplemented(self, verb):
        serverprint(f&#34;Invalid api call requested: {verb}&#34;)
        return make_response(mjson(None), self.headers[&#34;json&#34;])

    def list(self, givenTable):
        parts = givenTable.rsplit(&#34;.&#34;, 1)
        if len(parts) == 1:
            table = givenTable
            ext = &#34;json&#34;
        else:
            (table, ext) = parts
        if ext not in {&#34;json&#34;, &#34;tsv&#34;}:
            serverprint(f&#34;Invalid extension: {ext} in {givenTable}&#34;)
            return make_response(mjson(None), self.headers[&#34;json&#34;])

        data = None
        if table is not None and table not in SENSITIVE_TABLES:
            if table == &#34;contrib&#34;:
                data = self.getContribs(ext)
            else:
                context = self.context
                tableObj = Table(context, table)
                data = tableObj.wrap(None, logical=True)
        if data is None:
            serverprint(f&#34;Non existing table requested: {table}&#34;)
        return make_response(
            mjson(data) if ext == &#34;json&#34; else mktsv(data), self.headers[ext]
        )

    def view(self, table, givenEid):
        record = None
        eid = castObjectId(givenEid)
        if table is not None and eid is not None and table not in SENSITIVE_TABLES:
            context = self.context
            tableObj = Table(context, table)
            recordObj = tableObj.record(eid=eid)
            record = recordObj.wrapLogical()
            if table == &#34;contrib&#34;:
                extra = self.getExtra(record)
                for (k, v) in extra.items():
                    record[k] = v
                for k in SENSITIVE_FIELDS:
                    if k in record:
                        del record[k]
                k = &#34;typeContribution&#34;
                if k in record:
                    record[&#34;type&#34;] = record[k]
                    del record[k]
        if record is None:
            serverprint(f&#34;Non existing record requested: {table}/{givenEid}&#34;)
        return make_response(mjson(record), self.headers[&#34;json&#34;])

    def getExtra(self, record):
        context = self.context
        wf = context.wf
        workflow = wf.computeWorkflow(record)

        selected = G(workflow, N.selected)
        aStage = G(workflow, N.aStage)
        r2Stage = G(workflow, N.r2Stage)
        if r2Stage in {N.reviewAccept, N.reviewReject}:
            aStage = r2Stage
        score = G(workflow, N.score)
        assessed = ASSESSED_STATUS[aStage][0]
        aRank = (G(ASSESSED_RANK, aStage, default=0), score or 0)
        if aStage != N.reviewAccept:
            score = None

        extra = {
            N.assessed: assessed,
            N.arank: aRank,
            N.astage: aStage,
            N.score: score,
            N.selected: selected,
        }
        preR1Stage = G(workflow, N.r1Stage)
        noReview = aStage is None or aStage in NO_REVIEW
        inReview = aStage in IN_REVIEW
        advReview = preR1Stage in ADVISORY_REVIEW
        r1Stage = (
            &#34;noReview&#34;
            if noReview
            else preR1Stage
            if advReview
            else &#34;inReview&#34;
            if inReview
            else &#34;skipReview&#34;
        )
        r2Stage = (
            &#34;noReview&#34;
            if noReview
            else &#34;inReview&#34;
            if inReview
            else G(workflow, N.r2Stage)
        )
        reviewed1 = REVIEWED_STATUS[r1Stage][0]
        reviewed2 = REVIEWED_STATUS[r2Stage][0]
        r1Rank = G(REVIEW_RANK, r1Stage, default=0)
        r2Rank = G(REVIEW_RANK, r2Stage, default=0)
        extra.update(
            {
                REVIEWED1: reviewed1,
                REVIEWED2: reviewed2,
                R1RANK: r1Rank,
                R2RANK: r2Rank,
                N.r1Stage: r1Stage,
                N.r2Stage: r2Stage,
            }
        )
        return extra

    def getContribs(self, ext):
        context = self.context
        db = context.db
        countryType = self.countryType
        yearType = self.yearType
        typeType = self.typeType

        asTsv = ext == &#34;tsv&#34;

        contribs = []

        if asTsv:
            contribsFull = {G(r, N._id): r for r in db.getList(N.contrib)}
            context = self.context
            tableObj = Table(context, N.contrib)

        for record in db.bulkContribWorkflow(None, False):
            title = G(record, N.title)
            contribId = G(record, N._id)

            selected = G(record, N.selected)
            aStage = G(record, N.aStage)
            r2Stage = G(record, N.r2Stage)
            if r2Stage in {N.reviewAccept, N.reviewReject}:
                aStage = r2Stage
            score = G(record, N.score)
            assessed = ASSESSED_STATUS[aStage][0]
            aRank = (G(ASSESSED_RANK, aStage, default=0), score or 0)
            if aStage != N.reviewAccept:
                score = None

            countryRep = countryType.titleStr(
                G(db.country, G(record, N.country)), markup=None
            )
            yearRep = yearType.titleStr(G(db.year, G(record, N.year)), markup=None)
            typeRep = typeType.titleStr(
                G(db.typeContribution, G(record, N.type)), markup=None
            )

            contribRecord = {
                N._id: contribId,
                N.country: countryRep,
                N.year: yearRep,
                N.type: typeRep,
                N.title: title,
                N.assessed: assessed,
                N.arank: aRank,
                N.astage: aStage,
                N.score: score,
                N.selected: selected,
            }
            preR1Stage = G(record, N.r1Stage)
            noReview = aStage is None or aStage in NO_REVIEW
            inReview = aStage in IN_REVIEW
            advReview = preR1Stage in ADVISORY_REVIEW
            r1Stage = (
                &#34;noReview&#34;
                if noReview
                else preR1Stage
                if advReview
                else &#34;inReview&#34;
                if inReview
                else &#34;skipReview&#34;
            )
            r2Stage = (
                &#34;noReview&#34;
                if noReview
                else &#34;inReview&#34;
                if inReview
                else G(record, N.r2Stage)
            )
            reviewed1 = REVIEWED_STATUS[r1Stage][0]
            reviewed2 = REVIEWED_STATUS[r2Stage][0]
            r1Rank = G(REVIEW_RANK, r1Stage, default=0)
            r2Rank = G(REVIEW_RANK, r2Stage, default=0)
            contribRecord.update(
                {
                    REVIEWED1: reviewed1,
                    REVIEWED2: reviewed2,
                    R1RANK: r1Rank,
                    R2RANK: r2Rank,
                    N.r1Stage: r1Stage,
                    N.r2Stage: r2Stage,
                }
            )
            if asTsv:
                fullObj = tableObj.record(record=G(contribsFull, contribId, {}))
                full = fullObj.wrapLogical()
                contribRecord.update({
                    N.dateDecided: G(full, N.dateDecided),
                    N.vcc: G(full, N.vcc),
                    N.description: G(full, N.description),
                    N.contactPersonName: G(full, N.contactPersonName),
                    N.contactPersonEmail: G(full, N.contactPersonEmail),
                    N.urlContribution: G(full, N.urlContribution),
                    N.urlAcademic: G(full, N.urlAcademic),
                    N.tadirahObject: G(full, N.tadirahObject),
                    N.tadirahActivity: G(full, N.tadirahActivity),
                    N.tadirahTechnique: G(full, N.tadirahTechnique),
                    N.keyword: G(full, N.keyword),
                    N.discipline: G(full, N.discipline),
                })
            contribs.append(contribRecord)

        return contribs</code></pre>
</details>
<h3>Methods</h3>
<dl>
<dt id="control.api.Api.getContribs"><code class="name flex">
<span>def <span class="ident">getContribs</span></span>(<span>self, ext)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def getContribs(self, ext):
    context = self.context
    db = context.db
    countryType = self.countryType
    yearType = self.yearType
    typeType = self.typeType

    asTsv = ext == &#34;tsv&#34;

    contribs = []

    if asTsv:
        contribsFull = {G(r, N._id): r for r in db.getList(N.contrib)}
        context = self.context
        tableObj = Table(context, N.contrib)

    for record in db.bulkContribWorkflow(None, False):
        title = G(record, N.title)
        contribId = G(record, N._id)

        selected = G(record, N.selected)
        aStage = G(record, N.aStage)
        r2Stage = G(record, N.r2Stage)
        if r2Stage in {N.reviewAccept, N.reviewReject}:
            aStage = r2Stage
        score = G(record, N.score)
        assessed = ASSESSED_STATUS[aStage][0]
        aRank = (G(ASSESSED_RANK, aStage, default=0), score or 0)
        if aStage != N.reviewAccept:
            score = None

        countryRep = countryType.titleStr(
            G(db.country, G(record, N.country)), markup=None
        )
        yearRep = yearType.titleStr(G(db.year, G(record, N.year)), markup=None)
        typeRep = typeType.titleStr(
            G(db.typeContribution, G(record, N.type)), markup=None
        )

        contribRecord = {
            N._id: contribId,
            N.country: countryRep,
            N.year: yearRep,
            N.type: typeRep,
            N.title: title,
            N.assessed: assessed,
            N.arank: aRank,
            N.astage: aStage,
            N.score: score,
            N.selected: selected,
        }
        preR1Stage = G(record, N.r1Stage)
        noReview = aStage is None or aStage in NO_REVIEW
        inReview = aStage in IN_REVIEW
        advReview = preR1Stage in ADVISORY_REVIEW
        r1Stage = (
            &#34;noReview&#34;
            if noReview
            else preR1Stage
            if advReview
            else &#34;inReview&#34;
            if inReview
            else &#34;skipReview&#34;
        )
        r2Stage = (
            &#34;noReview&#34;
            if noReview
            else &#34;inReview&#34;
            if inReview
            else G(record, N.r2Stage)
        )
        reviewed1 = REVIEWED_STATUS[r1Stage][0]
        reviewed2 = REVIEWED_STATUS[r2Stage][0]
        r1Rank = G(REVIEW_RANK, r1Stage, default=0)
        r2Rank = G(REVIEW_RANK, r2Stage, default=0)
        contribRecord.update(
            {
                REVIEWED1: reviewed1,
                REVIEWED2: reviewed2,
                R1RANK: r1Rank,
                R2RANK: r2Rank,
                N.r1Stage: r1Stage,
                N.r2Stage: r2Stage,
            }
        )
        if asTsv:
            fullObj = tableObj.record(record=G(contribsFull, contribId, {}))
            full = fullObj.wrapLogical()
            contribRecord.update({
                N.dateDecided: G(full, N.dateDecided),
                N.vcc: G(full, N.vcc),
                N.description: G(full, N.description),
                N.contactPersonName: G(full, N.contactPersonName),
                N.contactPersonEmail: G(full, N.contactPersonEmail),
                N.urlContribution: G(full, N.urlContribution),
                N.urlAcademic: G(full, N.urlAcademic),
                N.tadirahObject: G(full, N.tadirahObject),
                N.tadirahActivity: G(full, N.tadirahActivity),
                N.tadirahTechnique: G(full, N.tadirahTechnique),
                N.keyword: G(full, N.keyword),
                N.discipline: G(full, N.discipline),
            })
        contribs.append(contribRecord)

    return contribs</code></pre>
</details>
</dd>
<dt id="control.api.Api.getExtra"><code class="name flex">
<span>def <span class="ident">getExtra</span></span>(<span>self, record)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def getExtra(self, record):
    context = self.context
    wf = context.wf
    workflow = wf.computeWorkflow(record)

    selected = G(workflow, N.selected)
    aStage = G(workflow, N.aStage)
    r2Stage = G(workflow, N.r2Stage)
    if r2Stage in {N.reviewAccept, N.reviewReject}:
        aStage = r2Stage
    score = G(workflow, N.score)
    assessed = ASSESSED_STATUS[aStage][0]
    aRank = (G(ASSESSED_RANK, aStage, default=0), score or 0)
    if aStage != N.reviewAccept:
        score = None

    extra = {
        N.assessed: assessed,
        N.arank: aRank,
        N.astage: aStage,
        N.score: score,
        N.selected: selected,
    }
    preR1Stage = G(workflow, N.r1Stage)
    noReview = aStage is None or aStage in NO_REVIEW
    inReview = aStage in IN_REVIEW
    advReview = preR1Stage in ADVISORY_REVIEW
    r1Stage = (
        &#34;noReview&#34;
        if noReview
        else preR1Stage
        if advReview
        else &#34;inReview&#34;
        if inReview
        else &#34;skipReview&#34;
    )
    r2Stage = (
        &#34;noReview&#34;
        if noReview
        else &#34;inReview&#34;
        if inReview
        else G(workflow, N.r2Stage)
    )
    reviewed1 = REVIEWED_STATUS[r1Stage][0]
    reviewed2 = REVIEWED_STATUS[r2Stage][0]
    r1Rank = G(REVIEW_RANK, r1Stage, default=0)
    r2Rank = G(REVIEW_RANK, r2Stage, default=0)
    extra.update(
        {
            REVIEWED1: reviewed1,
            REVIEWED2: reviewed2,
            R1RANK: r1Rank,
            R2RANK: r2Rank,
            N.r1Stage: r1Stage,
            N.r2Stage: r2Stage,
        }
    )
    return extra</code></pre>
</details>
</dd>
<dt id="control.api.Api.list"><code class="name flex">
<span>def <span class="ident">list</span></span>(<span>self, givenTable)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def list(self, givenTable):
    parts = givenTable.rsplit(&#34;.&#34;, 1)
    if len(parts) == 1:
        table = givenTable
        ext = &#34;json&#34;
    else:
        (table, ext) = parts
    if ext not in {&#34;json&#34;, &#34;tsv&#34;}:
        serverprint(f&#34;Invalid extension: {ext} in {givenTable}&#34;)
        return make_response(mjson(None), self.headers[&#34;json&#34;])

    data = None
    if table is not None and table not in SENSITIVE_TABLES:
        if table == &#34;contrib&#34;:
            data = self.getContribs(ext)
        else:
            context = self.context
            tableObj = Table(context, table)
            data = tableObj.wrap(None, logical=True)
    if data is None:
        serverprint(f&#34;Non existing table requested: {table}&#34;)
    return make_response(
        mjson(data) if ext == &#34;json&#34; else mktsv(data), self.headers[ext]
    )</code></pre>
</details>
</dd>
<dt id="control.api.Api.notimplemented"><code class="name flex">
<span>def <span class="ident">notimplemented</span></span>(<span>self, verb)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def notimplemented(self, verb):
    serverprint(f&#34;Invalid api call requested: {verb}&#34;)
    return make_response(mjson(None), self.headers[&#34;json&#34;])</code></pre>
</details>
</dd>
<dt id="control.api.Api.view"><code class="name flex">
<span>def <span class="ident">view</span></span>(<span>self, table, givenEid)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def view(self, table, givenEid):
    record = None
    eid = castObjectId(givenEid)
    if table is not None and eid is not None and table not in SENSITIVE_TABLES:
        context = self.context
        tableObj = Table(context, table)
        recordObj = tableObj.record(eid=eid)
        record = recordObj.wrapLogical()
        if table == &#34;contrib&#34;:
            extra = self.getExtra(record)
            for (k, v) in extra.items():
                record[k] = v
            for k in SENSITIVE_FIELDS:
                if k in record:
                    del record[k]
            k = &#34;typeContribution&#34;
            if k in record:
                record[&#34;type&#34;] = record[k]
                del record[k]
    if record is None:
        serverprint(f&#34;Non existing record requested: {table}/{givenEid}&#34;)
    return make_response(mjson(record), self.headers[&#34;json&#34;])</code></pre>
</details>
</dd>
</dl>
</dd>
</dl>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="control" href="index.html">control</a></code></li>
</ul>
</li>
<li><h3><a href="#header-classes">Classes</a></h3>
<ul>
<li>
<h4><code><a title="control.api.Api" href="#control.api.Api">Api</a></code></h4>
<ul class="">
<li><code><a title="control.api.Api.getContribs" href="#control.api.Api.getContribs">getContribs</a></code></li>
<li><code><a title="control.api.Api.getExtra" href="#control.api.Api.getExtra">getExtra</a></code></li>
<li><code><a title="control.api.Api.list" href="#control.api.Api.list">list</a></code></li>
<li><code><a title="control.api.Api.notimplemented" href="#control.api.Api.notimplemented">notimplemented</a></code></li>
<li><code><a title="control.api.Api.view" href="#control.api.Api.view">view</a></code></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc" title="pdoc: Python API documentation generator"><cite>pdoc</cite> 0.10.0</a>.</p>
</footer>
</body>
</html>